
<title> Thread Test </title>

<h1>Project Status</h1>

This project contains no usable code. The database backend works well enough to
run some test cases, but (for example):

  *  it is not possible to change the database page size.
  *  there is no way to actually lock the db to get a large transaction
     through.
  *  there are surely many bugs.

Even so, the prototype is advanced enough to use to test whether or not
multiple writers really can run concurrently on multi-processor systems.
That is the goal of the tests on this page - to verify the extent that
the database allows multiple clients in separate application threads to
run concurrent read/write transactions.

Performance is also compared against a single client using the standard
SQLite b-tree backend. This is not to show that hctree is faster than stock
SQLite in single-threaded deployments. Although it does test faster in
some write-heavy cases below, this is largely because it currently creates
slightly larger database files. The point is to show that it runs at a
similar speed for the cases tested. There would be no point in running 8
threads concurrently if each of them were an order of magnitude slower than
other database backends.

<h1>Test Overview</h1>

All tests use the same database. The schema is:

<pre>
      CREATE TABLE tbl(
         a INTEGER PRIMARY KEY,
         b BLOB(200),
         c CHAR(64)
      );
      CREATE INDEX tbl_i1 ON tbl(substr(c, 1, 16));
      CREATE INDEX tbl_i2 ON tbl(substr(c, 2, 16));
</pre>

The initial database contains 1,000,000 rows. Column "a" contains values
1 to 1,000,000. Column "b" contains a 200 byte blob value. Column "c"
contains a 64 byte text value.

Each test consists of between 1 and 8 threads, all running transactions
as fast as possible for 30 seconds. Each transaction consists of:

<pre>
      BEGIN;
        -- repeat <i>nScan</i> times:
        SELECT * FROM tbl WHERE substr(c, 1, 16)>=hex(frandomblob(8)) ORDER BY substr(c, 1, 16) LIMIT 10;
</pre>
<pre>
        -- repeat <i>nUpdate</i> times:
        UPDATE tbl SET b=updateblob(b, ?, ?), c=hex(frandomblob(32)) WHERE a = ?;
      COMMIT;
</pre>

Where <i>nScan</i> and <i>nUpdate</i> are parameters for the test.

As well as tests using hctree with between 1 and 8 client threads, tests
are also run against stock SQLite using a single client and thread. For
these tests, SQLite is configured with the following:

<pre>
      PRAGMA journal_mode = wal";
      PRAGMA wal_autocheckpoint = 10000";
      PRAGMA mmap_size = 1000000000";
      PRAGMA locking_mode = exclusive;
      PRAGMA synchronous = off;
</pre>

<h1>Test Results</h1>

Each cell of the table below contains results for two test runs. For
each test run, three values are reported:

  *  the total number of transactions per second, 
  *  the percentage of these transactions that failed with SQLITE_BUSY (in
     parenthesis), and
  *  the per-cpu speed that this represents, relative to the single threaded
     case, as a percentage (in bold).

For example, the first run of the 8 thread test with nUpdate=5 and nScan=10
is reported as "71353 (2.3%) <b>74%</b>" (the cell with the <span
    style=background-color:lightgrey>grey background</span> below). This means that, considering all
16 threads, throughput was 71353 transactions per second. This is 4459 per
second for each CPU, or roughly 74% of the average speed of the single
threaded tests - 5996 transactions per second. Roughly 2.3% of attempted
transactions failed to COMMIT due to conflicts between threads.

These tests were run on an "AMD Ryzen 9 5950x" (16 cores) with copious memory
available. Advanced BIOS CPU frequency management features like "Core Boost",
"AMD Cool & Quiet" and "Simultaneous Multi-Threading" were all disabled.


<table border=1 cellpadding=10><tr><th>Test<th>Stock SQLite<th>HCT 1 thread<th>HCT 2 threads<th>HCT 4 threads<th>HCT 8 threads<th>HCT 12 threads<th>HCT 16 threads
<tr><td>nUpdate=1 nScan=0
<td nowrap>48074(0.0%) <b>80%</b><br>47208(0.0%) <b>79%</b><br><td nowrap>63202(0.0%) <b>105%</b><br>56936(0.0%) <b>95%</b><br><td nowrap>104875(0.0%) <b>87%</b><br>101975(0.0%) <b>85%</b><br><td nowrap>204678(0.0%) <b>85%</b><br>204426(0.0%) <b>85%</b><br><td nowrap>385790(0.0%) <b>80%</b><br>366678(0.0%) <b>76%</b><br><td nowrap>527118(0.0%) <b>73%</b><br>493018(0.0%) <b>68%</b><br><td nowrap>583832(0.0%) <b>61%</b><br>587939(0.0%) <b>61%</b><br>
<tr><td>nUpdate=1 nScan=1
<td nowrap>32851(0.0%) <b>88%</b><br>32807(0.0%) <b>88%</b><br><td nowrap>36924(0.0%) <b>99%</b><br>37459(0.0%) <b>101%</b><br><td nowrap>69845(0.0%) <b>94%</b><br>67520(0.0%) <b>91%</b><br><td nowrap>134090(0.0%) <b>90%</b><br>134797(0.0%) <b>91%</b><br><td nowrap>257604(0.0%) <b>87%</b><br>255751(0.0%) <b>86%</b><br><td nowrap>360913(0.0%) <b>81%</b><br>357068(0.0%) <b>80%</b><br><td nowrap>430462(0.0%) <b>72%</b><br>430766(0.1%) <b>72%</b><br>
<tr><td>nUpdate=1 nScan=5
<td nowrap>14865(0.0%) <b>90%</b><br>14734(0.0%) <b>89%</b><br><td nowrap>16543(0.0%) <b>100%</b><br>16470(0.0%) <b>100%</b><br><td nowrap>31593(0.0%) <b>96%</b><br>31531(0.0%) <b>96%</b><br><td nowrap>62233(0.0%) <b>94%</b><br>61975(0.0%) <b>94%</b><br><td nowrap>121238(0.1%) <b>92%</b><br>119825(0.1%) <b>91%</b><br><td nowrap>175249(0.1%) <b>88%</b><br>174167(0.1%) <b>88%</b><br><td nowrap>221458(0.2%) <b>84%</b><br>220553(0.2%) <b>84%</b><br>
<tr><td>nUpdate=1 nScan=10
<td nowrap>9276(0.0%) <b>93%</b><br>9163(0.0%) <b>92%</b><br><td nowrap>9993(0.0%) <b>100%</b><br>9894(0.0%) <b>100%</b><br><td nowrap>19053(0.0%) <b>96%</b><br>18732(0.0%) <b>94%</b><br><td nowrap>37738(0.1%) <b>95%</b><br>37257(0.1%) <b>94%</b><br><td nowrap>73594(0.2%) <b>93%</b><br>72908(0.1%) <b>92%</b><br><td nowrap>107598(0.2%) <b>90%</b><br>105623(0.2%) <b>89%</b><br><td nowrap>137171(0.3%) <b>86%</b><br>136612(0.3%) <b>86%</b><br>
<tr><td>nUpdate=1 nScan=25
<td nowrap>4224(0.0%) <b>94%</b><br>4176(0.0%) <b>93%</b><br><td nowrap>4511(0.0%) <b>101%</b><br>4445(0.0%) <b>99%</b><br><td nowrap>8610(0.1%) <b>96%</b><br>8656(0.1%) <b>97%</b><br><td nowrap>17176(0.2%) <b>96%</b><br>17091(0.1%) <b>95%</b><br><td nowrap>33902(0.4%) <b>95%</b><br>33610(0.4%) <b>94%</b><br><td nowrap>49970(0.6%) <b>93%</b><br>49477(0.6%) <b>92%</b><br><td nowrap>64842(0.8%) <b>91%</b><br>64455(0.7%) <b>90%</b><br>
<tr><td>nUpdate=5 nScan=0
<td nowrap>9769(0.0%) <b>78%</b><br>9793(0.0%) <b>78%</b><br><td nowrap>12604(0.0%) <b>101%</b><br>12461(0.0%) <b>99%</b><br><td nowrap>23059(0.0%) <b>92%</b><br>23156(0.0%) <b>92%</b><br><td nowrap>44885(0.0%) <b>90%</b><br>44901(0.1%) <b>90%</b><br><td nowrap>81792(0.1%) <b>82%</b><br>81049(0.1%) <b>81%</b><br><td nowrap>110201(0.3%) <b>73%</b><br>108192(0.1%) <b>72%</b><br><td nowrap>121753(0.2%) <b>61%</b><br>123666(0.2%) <b>62%</b><br>
<tr><td>nUpdate=5 nScan=1
<td nowrap>8697(0.0%) <b>79%</b><br>8446(0.0%) <b>76%</b><br><td nowrap>11112(0.0%) <b>101%</b><br>10996(0.0%) <b>99%</b><br><td nowrap>20623(0.0%) <b>93%</b><br>20473(0.1%) <b>93%</b><br><td nowrap>39886(0.1%) <b>90%</b><br>39724(0.1%) <b>90%</b><br><td nowrap>73555(0.3%) <b>83%</b><br>73325(0.2%) <b>83%</b><br><td nowrap>97844(0.3%) <b>74%</b><br>97633(0.4%) <b>74%</b><br><td nowrap>115456(0.5%) <b>65%</b><br>114664(0.4%) <b>65%</b><br>
<tr><td>nUpdate=5 nScan=5
<td nowrap>6523(0.0%) <b>82%</b><br>6409(0.0%) <b>80%</b><br><td nowrap>8070(0.0%) <b>101%</b><br>7937(0.0%) <b>99%</b><br><td nowrap>14952(0.2%) <b>93%</b><br>14981(0.1%) <b>94%</b><br><td nowrap>29269(0.3%) <b>91%</b><br>29102(0.3%) <b>91%</b><br><td nowrap>54895(0.6%) <b>86%</b><br>54642(0.6%) <b>85%</b><br><td nowrap>75150(1.0%) <b>78%</b><br>74720(1.0%) <b>78%</b><br><td nowrap>88965(1.4%) <b>69%</b><br>88347(1.3%) <b>69%</b><br>
<tr><td>nUpdate=5 nScan=10
<td nowrap>5129(0.0%) <b>86%</b><br>5128(0.0%) <b>86%</b><br><td nowrap>6013(0.0%) <b>100%</b><br>5979(0.0%) <b>100%</b><br><td nowrap>11321(0.2%) <b>94%</b><br>11168(0.1%) <b>93%</b><br><td nowrap>22109(0.4%) <b>92%</b><br>22198(0.5%) <b>93%</b><br><td nowrap>42285(1.1%) <b>88%</b><br>42163(1.0%) <b>88%</b><br><td nowrap>58980(1.6%) <b>82%</b><br>58979(1.6%) <b>82%</b><br><td nowrap style=background-color:lightgrey>71353(2.3%) <b>74%</b><br>71318(2.3%) <b>74%</b><br>
<tr><td>nUpdate=5 nScan=25
<td nowrap>3055(0.0%) <b>90%</b><br>3041(0.0%) <b>90%</b><br><td nowrap>3389(0.0%) <b>100%</b><br>3399(0.0%) <b>100%</b><br><td nowrap>6532(0.3%) <b>96%</b><br>6490(0.3%) <b>96%</b><br><td nowrap>12779(1.0%) <b>94%</b><br>12811(0.9%) <b>94%</b><br><td nowrap>24800(2.0%) <b>91%</b><br>24897(2.2%) <b>92%</b><br><td nowrap>35737(3.3%) <b>88%</b><br>35690(3.3%) <b>88%</b><br><td nowrap>45161(4.7%) <b>83%</b><br>44974(4.5%) <b>83%</b><br>
<tr><td>nUpdate=10 nScan=0
<td nowrap>4661(0.0%) <b>73%</b><br>4318(0.0%) <b>68%</b><br><td nowrap>6371(0.0%) <b>100%</b><br>6335(0.0%) <b>100%</b><br><td nowrap>11726(0.3%) <b>92%</b><br>12035(0.0%) <b>95%</b><br><td nowrap>22742(0.2%) <b>89%</b><br>22877(0.2%) <b>90%</b><br><td nowrap>41687(0.4%) <b>82%</b><br>40871(0.1%) <b>80%</b><br><td nowrap>54205(0.5%) <b>71%</b><br>53879(0.5%) <b>71%</b><br><td nowrap>61703(0.6%) <b>61%</b><br>62434(0.7%) <b>61%</b><br>
<tr><td>nUpdate=10 nScan=1
<td nowrap>4478(0.0%) <b>77%</b><br>4582(0.0%) <b>78%</b><br><td nowrap>5771(0.0%) <b>99%</b><br>5922(0.0%) <b>101%</b><br><td nowrap>11098(0.1%) <b>95%</b><br>10781(0.0%) <b>92%</b><br><td nowrap>21319(0.3%) <b>91%</b><br>21031(0.3%) <b>90%</b><br><td nowrap>38907(0.6%) <b>83%</b><br>38473(0.5%) <b>82%</b><br><td nowrap>51300(0.8%) <b>73%</b><br>50805(0.8%) <b>72%</b><br><td nowrap>59556(1.3%) <b>64%</b><br>59669(1.3%) <b>64%</b><br>
<tr><td>nUpdate=10 nScan=5
<td nowrap>3817(0.0%) <b>79%</b><br>3851(0.0%) <b>79%</b><br><td nowrap>4870(0.0%) <b>100%</b><br>4826(0.0%) <b>100%</b><br><td nowrap>9159(0.1%) <b>94%</b><br>9066(0.2%) <b>94%</b><br><td nowrap>17644(0.7%) <b>91%</b><br>17694(0.6%) <b>91%</b><br><td nowrap>32481(1.3%) <b>84%</b><br>32577(1.4%) <b>84%</b><br><td nowrap>43473(2.2%) <b>75%</b><br>43333(2.1%) <b>74%</b><br><td nowrap>51326(3.0%) <b>66%</b><br>51616(3.1%) <b>67%</b><br>
<tr><td>nUpdate=10 nScan=10
<td nowrap>3362(0.0%) <b>83%</b><br>3172(0.0%) <b>79%</b><br><td nowrap>4058(0.0%) <b>101%</b><br>4004(0.0%) <b>99%</b><br><td nowrap>7545(0.3%) <b>94%</b><br>7695(0.3%) <b>95%</b><br><td nowrap>14640(0.9%) <b>91%</b><br>14800(0.9%) <b>92%</b><br><td nowrap>27770(2.4%) <b>86%</b><br>27690(2.6%) <b>86%</b><br><td nowrap>37267(3.4%) <b>77%</b><br>37181(3.6%) <b>77%</b><br><td nowrap>44637(5.2%) <b>69%</b><br>44713(5.3%) <b>69%</b><br>
<tr><td>nUpdate=10 nScan=25
<td nowrap>2257(0.0%) <b>85%</b><br>2236(0.0%) <b>84%</b><br><td nowrap>2633(0.0%) <b>99%</b><br>2687(0.0%) <b>101%</b><br><td nowrap>5059(0.7%) <b>95%</b><br>4970(0.6%) <b>93%</b><br><td nowrap>9840(2.0%) <b>92%</b><br>9837(2.1%) <b>92%</b><br><td nowrap>18769(4.9%) <b>88%</b><br>18746(5.0%) <b>88%</b><br><td nowrap>26371(7.8%) <b>83%</b><br>26472(7.6%) <b>83%</b><br><td nowrap>31997(9.9%) <b>75%</b><br>31984(10.3%) <b>75%</b><br>
<tr><td>nUpdate=25 nScan=0
<td nowrap>1862(0.0%) <b>72%</b><br>1879(0.0%) <b>73%</b><br><td nowrap>2573(0.0%) <b>100%</b><br>2577(0.0%) <b>100%</b><br><td nowrap>4855(0.1%) <b>94%</b><br>4813(0.1%) <b>93%</b><br><td nowrap>9209(0.2%) <b>89%</b><br>9206(1.0%) <b>89%</b><br><td nowrap>16575(2.2%) <b>80%</b><br>16495(0.9%) <b>80%</b><br><td nowrap>22068(3.1%) <b>71%</b><br>21788(2.7%) <b>71%</b><br><td nowrap>25227(3.8%) <b>61%</b><br>25302(4.3%) <b>61%</b><br>
<tr><td>nUpdate=0 nScan=1
<td nowrap>108348(0.0%) <b>88%</b><br>106654(0.0%) <b>86%</b><br><td nowrap>123645(0.0%) <b>100%</b><br>123419(0.0%) <b>100%</b><br><td nowrap>246517(0.0%) <b>100%</b><br>241484(0.0%) <b>98%</b><br><td nowrap>490669(0.0%) <b>99%</b><br>490692(0.0%) <b>99%</b><br><td nowrap>969998(0.0%) <b>98%</b><br>974069(0.0%) <b>99%</b><br><td nowrap>1433778(0.0%) <b>97%</b><br>1431610(0.0%) <b>97%</b><br><td nowrap>1897971(0.0%) <b>96%</b><br>1898751(0.0%) <b>96%</b><br>
<tr><td>nUpdate=0 nScan=5
<td nowrap>25680(0.0%) <b>102%</b><br>25300(0.0%) <b>101%</b><br><td nowrap>25060(0.0%) <b>100%</b><br>25221(0.0%) <b>100%</b><br><td nowrap>50687(0.0%) <b>101%</b><br>50403(0.0%) <b>100%</b><br><td nowrap>98564(0.0%) <b>98%</b><br>97517(0.0%) <b>97%</b><br><td nowrap>197553(0.0%) <b>98%</b><br>198088(0.0%) <b>98%</b><br><td nowrap>292339(0.0%) <b>97%</b><br>291727(0.0%) <b>97%</b><br><td nowrap>384094(0.0%) <b>95%</b><br>385808(0.0%) <b>96%</b><br>
<tr><td>nUpdate=0 nScan=10
<td nowrap>12869(0.0%) <b>103%</b><br>12990(0.0%) <b>104%</b><br><td nowrap>12485(0.0%) <b>100%</b><br>12426(0.0%) <b>100%</b><br><td nowrap>25159(0.0%) <b>101%</b><br>25150(0.0%) <b>101%</b><br><td nowrap>49477(0.0%) <b>99%</b><br>49707(0.0%) <b>100%</b><br><td nowrap>99195(0.0%) <b>100%</b><br>98372(0.0%) <b>99%</b><br><td nowrap>146716(0.0%) <b>98%</b><br>146425(0.0%) <b>98%</b><br><td nowrap>191750(0.0%) <b>96%</b><br>191512(0.0%) <b>96%</b><br>
<tr><td>nUpdate=0 nScan=25
<td nowrap>5298(0.0%) <b>105%</b><br>5288(0.0%) <b>105%</b><br><td nowrap>5049(0.0%) <b>100%</b><br>5038(0.0%) <b>100%</b><br><td nowrap>9971(0.0%) <b>99%</b><br>10035(0.0%) <b>99%</b><br><td nowrap>19774(0.0%) <b>98%</b><br>19944(0.0%) <b>99%</b><br><td nowrap>39425(0.0%) <b>98%</b><br>39265(0.0%) <b>97%</b><br><td nowrap>58359(0.0%) <b>96%</b><br>58325(0.0%) <b>96%</b><br><td nowrap>76920(0.0%) <b>95%</b><br>76650(0.0%) <b>95%</b><br>
</table>
