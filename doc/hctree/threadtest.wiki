
<title> Thread Test </title>

<h1>Project Status</h1>

This project contains no usable code. The database backend works well enough to
run some test cases, but (for example):

  *  the "EDKS" feature, which prevents excess delete keys from accumlating
     as a result of an unfortunate sequence of writes and deletes, is not
     implemented.
  *  it is not possible to change the database page size.
  *  there are surely many bugs.

Even so, the prototype is advanced enough to use to test whether or not
multiple writers really can run concurrently on multi-processor systems.
That is the goal of the tests on this page - to verify the extent that
the database allows multiple clients in separate application threads to
run concurrent read/write transactions.

Performance is also compared against a single client using the standard
SQLite b-tree backend. This is not to show that hctree is faster than stock
SQLite in single-threaded deployments. Although it does test faster in
some write-heavy cases below, this is largely because it currently creates
slightly larger database files. The point is to show that it runs at a
similar speed for the cases tested. There would be no point in running 8
threads concurrently if each of them were an order of magnitude slower than
other database backends.

<h1>Test Overview</h1>

All tests use the same database. The schema is:

<pre>
      CREATE TABLE tbl(
         a INTEGER PRIMARY KEY,
         b BLOB(200),
         c CHAR(64)
      );
      CREATE INDEX tbl_i1 ON tbl(substr(c, 1, 16));
      CREATE INDEX tbl_i2 ON tbl(substr(c, 2, 16));
</pre>

The initial database contains 1,000,000 rows. Column "a" contains values
1 to 1,000,000. Column "b" contains a 200 byte blob value. Column "c"
contains a 64 byte text value.

Each test consists of between 1 and 8 threads, all running transactions
as fast as possible for 30 seconds. Each transaction consists of:

<pre>
      BEGIN;
        -- repeat <i>nScan</i> times:
        SELECT * FROM tbl WHERE substr(c, 1, 16)>=hex(frandomblob(8)) ORDER BY substr(c, 1, 16) LIMIT 10;
</pre>
<pre>
        -- repeat <i>nUpdate</i> times:
        UPDATE tbl SET b=updateblob(b, ?, ?), c=hex(frandomblob(32)) WHERE a = ?;
      COMMIT;
</pre>

Where <i>nScan</i> and <i>nUpdate</i> are parameters for the test.

As well as tests using hctree with between 1 and 8 client threads, tests
are also run against stock SQLite using a single client and thread. For
these tests, SQLite is configured with the following:

<pre>
      PRAGMA journal_mode = wal";
      PRAGMA wal_autocheckpoint = 10000";
      PRAGMA mmap_size = 1000000000";
      PRAGMA locking_mode = exclusive;
      PRAGMA synchronous = off;
</pre>

<h1>Test Results</h1>

Each cell of the table below contains results for two test runs. For
each test run, three values are reported:

  *  the total number of transactions per second, 
  *  the percentage of these transactions that failed with SQLITE_BUSY (in
     parenthesis), and
  *  the per-cpu speed that this represents, relative to the single threaded
     case, as a percentage (in bold).

For example, the first run of the 8 thread test with nUpdate=5 and nScan=10
is reported as "27841 (1.8%) <b>85%</b>" (the cell with the <span
    style=background-color:lightgrey>grey background</span> below). This means that, considering all
8 threads, throughput was 27841 transactions per second. This is 3480 per
second for each CPU, or roughly 85% of the average speed of the single
threaded tests - 4094 transactions per second. Roughly 1.8% of attempted
transactions failed to COMMIT due to conflicts between threads.

These tests were run on an "AMD Ryzen 7 2700" (8 cores) with copious memory
available. Advanced BIOS CPU frequency management features like "Core Boost",
"AMD Cool & Quiet" and "Simultaneous Multi-Threading" were all disabled.


<table border=1 cellpadding=10><tr><th>Test<th>Stock SQLite<th>HCT 1 thread<th>HCT 2 threads<th>HCT 4 threads<th>HCT 6 threads<th>HCT 8 threads
<tr><td>nUpdate=0 nScan=1
<td nowrap>87295(0.0%) <b>100%</b><br>77734(0.0%) <b>89%</b><br><td nowrap>89912(0.0%) <b>103%</b><br>85079(0.0%) <b>97%</b><br><td nowrap>176540(0.0%) <b>101%</b><br>180467(0.0%) <b>103%</b><br><td nowrap>356519(0.0%) <b>102%</b><br>355716(0.0%) <b>102%</b><br><td nowrap>532009(0.0%) <b>101%</b><br>532813(0.0%) <b>101%</b><br><td nowrap>702755(0.0%) <b>100%</b><br>701430(0.0%) <b>100%</b><br>
<tr><td>nUpdate=0 nScan=5
<td nowrap>18749(0.0%) <b>105%</b><br>18355(0.0%) <b>103%</b><br><td nowrap>17448(0.0%) <b>98%</b><br>18250(0.0%) <b>102%</b><br><td nowrap>36592(0.0%) <b>103%</b><br>36213(0.0%) <b>101%</b><br><td nowrap>72416(0.0%) <b>101%</b><br>72577(0.0%) <b>102%</b><br><td nowrap>108364(0.0%) <b>101%</b><br>108100(0.0%) <b>101%</b><br><td nowrap>142495(0.0%) <b>100%</b><br>142700(0.0%) <b>100%</b><br>
<tr><td>nUpdate=0 nScan=10
<td nowrap>9567(0.0%) <b>107%</b><br>9403(0.0%) <b>105%</b><br><td nowrap>8761(0.0%) <b>98%</b><br>9196(0.0%) <b>102%</b><br><td nowrap>18189(0.0%) <b>101%</b><br>18251(0.0%) <b>102%</b><br><td nowrap>36353(0.0%) <b>101%</b><br>36348(0.0%) <b>101%</b><br><td nowrap>54195(0.0%) <b>101%</b><br>53911(0.0%) <b>100%</b><br><td nowrap>71413(0.0%) <b>99%</b><br>71390(0.0%) <b>99%</b><br>
<tr><td>nUpdate=0 nScan=25
<td nowrap>3898(0.0%) <b>106%</b><br>3793(0.0%) <b>103%</b><br><td nowrap>3723(0.0%) <b>101%</b><br>3652(0.0%) <b>99%</b><br><td nowrap>7369(0.0%) <b>100%</b><br>7364(0.0%) <b>100%</b><br><td nowrap>14471(0.0%) <b>98%</b><br>14474(0.0%) <b>98%</b><br><td nowrap>21711(0.0%) <b>98%</b><br>21639(0.0%) <b>98%</b><br><td nowrap>28563(0.0%) <b>97%</b><br>28571(0.0%) <b>97%</b><br>
<tr><td>nUpdate=1 nScan=0
<td nowrap>32106(0.0%) <b>86%</b><br>29690(0.0%) <b>79%</b><br><td nowrap>37029(0.0%) <b>99%</b><br>37905(0.0%) <b>101%</b><br><td nowrap>73234(0.0%) <b>98%</b><br>72268(0.0%) <b>96%</b><br><td nowrap>137192(0.0%) <b>92%</b><br>135848(0.0%) <b>91%</b><br><td nowrap>193005(0.0%) <b>86%</b><br>194181(0.0%) <b>86%</b><br><td nowrap>242250(0.0%) <b>81%</b><br>242728(0.0%) <b>81%</b><br>
<tr><td>nUpdate=1 nScan=1
<td nowrap>22347(0.0%) <b>89%</b><br>22043(0.0%) <b>88%</b><br><td nowrap>25536(0.0%) <b>102%</b><br>24762(0.0%) <b>98%</b><br><td nowrap>48577(0.0%) <b>97%</b><br>48647(0.0%) <b>97%</b><br><td nowrap>92570(0.0%) <b>92%</b><br>92906(0.0%) <b>92%</b><br><td nowrap>133393(0.0%) <b>88%</b><br>131944(0.0%) <b>87%</b><br><td nowrap>168731(0.0%) <b>84%</b><br>167434(0.0%) <b>83%</b><br>
<tr><td>nUpdate=1 nScan=5
<td nowrap>10567(0.0%) <b>92%</b><br>10669(0.0%) <b>93%</b><br><td nowrap>11613(0.0%) <b>101%</b><br>11375(0.0%) <b>99%</b><br><td nowrap>22195(0.0%) <b>97%</b><br>22595(0.0%) <b>98%</b><br><td nowrap>44006(0.1%) <b>96%</b><br>43465(0.1%) <b>95%</b><br><td nowrap>63952(0.1%) <b>93%</b><br>63695(0.1%) <b>92%</b><br><td nowrap>82701(0.1%) <b>90%</b><br>82594(0.1%) <b>90%</b><br>
<tr><td>nUpdate=1 nScan=10
<td nowrap>6492(0.0%) <b>93%</b><br>6510(0.0%) <b>93%</b><br><td nowrap>7005(0.0%) <b>101%</b><br>6934(0.0%) <b>99%</b><br><td nowrap>13462(0.0%) <b>97%</b><br>13256(0.0%) <b>95%</b><br><td nowrap>26773(0.1%) <b>96%</b><br>26541(0.1%) <b>95%</b><br><td nowrap>39182(0.2%) <b>94%</b><br>38972(0.2%) <b>93%</b><br><td nowrap>50974(0.3%) <b>91%</b><br>50594(0.3%) <b>91%</b><br>
<tr><td>nUpdate=1 nScan=25
<td nowrap>3017(0.0%) <b>97%</b><br>3020(0.0%) <b>97%</b><br><td nowrap>3141(0.0%) <b>101%</b><br>3087(0.0%) <b>99%</b><br><td nowrap>6128(0.1%) <b>98%</b><br>6176(0.1%) <b>99%</b><br><td nowrap>12304(0.3%) <b>99%</b><br>12265(0.3%) <b>98%</b><br><td nowrap>18167(0.5%) <b>97%</b><br>18088(0.4%) <b>97%</b><br><td nowrap>23784(0.6%) <b>95%</b><br>23673(0.7%) <b>95%</b><br>
<tr><td>nUpdate=5 nScan=0
<td nowrap>6602(0.0%) <b>79%</b><br>6485(0.0%) <b>78%</b><br><td nowrap>8385(0.0%) <b>100%</b><br>8350(0.0%) <b>100%</b><br><td nowrap>16138(0.1%) <b>96%</b><br>15879(0.0%) <b>95%</b><br><td nowrap>30031(0.0%) <b>90%</b><br>29841(0.1%) <b>89%</b><br><td nowrap>41955(0.1%) <b>84%</b><br>41631(0.1%) <b>83%</b><br><td nowrap>52484(0.1%) <b>78%</b><br>52529(0.1%) <b>78%</b><br>
<tr><td>nUpdate=5 nScan=1
<td nowrap>5760(0.0%) <b>78%</b><br>5866(0.0%) <b>79%</b><br><td nowrap>7409(0.0%) <b>100%</b><br>7409(0.0%) <b>100%</b><br><td nowrap>14146(0.0%) <b>95%</b><br>14187(0.1%) <b>96%</b><br><td nowrap>26808(0.1%) <b>90%</b><br>26653(0.1%) <b>90%</b><br><td nowrap>37407(0.2%) <b>84%</b><br>37363(0.2%) <b>84%</b><br><td nowrap>47049(0.3%) <b>79%</b><br>46832(0.4%) <b>79%</b><br>
<tr><td>nUpdate=5 nScan=5
<td nowrap>4543(0.0%) <b>84%</b><br>4564(0.0%) <b>84%</b><br><td nowrap>5411(0.0%) <b>100%</b><br>5394(0.0%) <b>100%</b><br><td nowrap>10480(0.2%) <b>97%</b><br>10407(0.1%) <b>96%</b><br><td nowrap>19904(0.4%) <b>92%</b><br>19825(0.4%) <b>92%</b><br><td nowrap>28300(0.7%) <b>87%</b><br>28134(0.7%) <b>87%</b><br><td nowrap>35531(0.9%) <b>82%</b><br>35476(0.9%) <b>82%</b><br>
<tr><td>nUpdate=5 nScan=10
<td nowrap>3536(0.0%) <b>86%</b><br>3557(0.0%) <b>87%</b><br><td
nowrap>4128(0.0%) <b>101%</b><br>4060(0.0%) <b>99%</b><br><td nowrap>7992(0.2%)
  <b>98%</b><br>7876(0.2%) <b>96%</b><br><td nowrap>15317(0.7%)
  <b>94%</b><br>15321(0.7%) <b>94%</b><br><td nowrap>21994(1.3%)
  <b>90%</b><br>21932(1.1%) <b>89%</b><br><td style=background-color:lightgrey>27841(1.8%) <b>85%</b><br>27763(1.7%) <b>85%</b><br>
<tr><td>nUpdate=5 nScan=25
<td nowrap>2158(0.0%) <b>91%</b><br>2161(0.0%) <b>91%</b><br><td nowrap>2354(0.0%) <b>99%</b><br>2381(0.0%) <b>101%</b><br><td nowrap>4663(0.5%) <b>98%</b><br>4677(0.5%) <b>99%</b><br><td nowrap>9104(1.4%) <b>96%</b><br>9092(1.7%) <b>96%</b><br><td nowrap>13273(2.6%) <b>93%</b><br>13248(2.7%) <b>93%</b><br><td nowrap>16971(3.7%) <b>90%</b><br>16978(3.5%) <b>90%</b><br>
<tr><td>nUpdate=10 nScan=0
<td nowrap>3311(0.0%) <b>78%</b><br>3296(0.0%) <b>78%</b><br><td nowrap>4181(0.0%) <b>99%</b><br>4296(0.0%) <b>101%</b><br><td nowrap>8172(0.0%) <b>96%</b><br>8304(0.0%) <b>98%</b><br><td nowrap>15225(0.2%) <b>90%</b><br>15319(0.5%) <b>90%</b><br><td nowrap>21167(0.1%) <b>83%</b><br>21432(0.4%) <b>84%</b><br><td nowrap>26642(0.4%) <b>79%</b><br>26639(0.3%) <b>79%</b><br>
<tr><td>nUpdate=10 nScan=1
<td nowrap>3069(0.0%) <b>77%</b><br>3006(0.0%) <b>76%</b><br><td nowrap>3974(0.0%) <b>100%</b><br>3954(0.0%) <b>100%</b><br><td nowrap>7562(0.1%) <b>95%</b><br>7634(0.1%) <b>96%</b><br><td nowrap>14349(0.4%) <b>90%</b><br>14280(0.4%) <b>90%</b><br><td nowrap>20075(0.6%) <b>84%</b><br>20037(0.6%) <b>84%</b><br><td nowrap>25071(0.6%) <b>79%</b><br>25082(0.8%) <b>79%</b><br>
<tr><td>nUpdate=10 nScan=5
<td nowrap>2649(0.0%) <b>81%</b><br>2660(0.0%) <b>81%</b><br><td nowrap>3267(0.0%) <b>99%</b><br>3304(0.0%) <b>101%</b><br><td nowrap>6345(0.3%) <b>97%</b><br>6312(0.3%) <b>96%</b><br><td nowrap>11906(1.0%) <b>91%</b><br>11910(0.8%) <b>91%</b><br><td nowrap>16729(1.5%) <b>85%</b><br>16762(1.5%) <b>85%</b><br><td nowrap>21042(1.9%) <b>80%</b><br>21060(2.2%) <b>80%</b><br>
<tr><td>nUpdate=10 nScan=10
<td nowrap>2310(0.0%) <b>85%</b><br>2206(0.0%) <b>81%</b><br><td nowrap>2707(0.0%) <b>99%</b><br>2746(0.0%) <b>101%</b><br><td nowrap>5255(0.5%) <b>96%</b><br>5274(0.5%) <b>97%</b><br><td nowrap>10056(1.6%) <b>92%</b><br>10052(1.5%) <b>92%</b><br><td nowrap>14235(2.6%) <b>87%</b><br>14176(2.1%) <b>87%</b><br><td nowrap>17853(3.8%) <b>82%</b><br>17862(3.9%) <b>82%</b><br>
<tr><td>nUpdate=10 nScan=25
<td nowrap>1607(0.0%) <b>87%</b><br>1600(0.0%) <b>87%</b><br><td nowrap>1850(0.0%) <b>101%</b><br>1824(0.0%) <b>99%</b><br><td nowrap>3527(1.0%) <b>96%</b><br>3558(1.2%) <b>97%</b><br><td nowrap>6884(3.1%) <b>94%</b><br>6875(3.5%) <b>94%</b><br><td nowrap>9879(5.7%) <b>90%</b><br>9862(5.4%) <b>89%</b><br><td nowrap>12454(7.7%) <b>85%</b><br>12430(7.9%) <b>85%</b><br>
<tr><td>nUpdate=25 nScan=0
<td nowrap>1135(0.0%) <b>67%</b><br>1236(0.0%) <b>73%</b><br><td nowrap>1722(0.0%) <b>101%</b><br>1684(0.0%) <b>99%</b><br><td nowrap>3317(1.9%) <b>97%</b><br>3280(0.1%) <b>96%</b><br><td nowrap>6147(0.2%) <b>90%</b><br>6119(0.2%) <b>90%</b><br><td nowrap>8566(0.9%) <b>84%</b><br>8569(0.9%) <b>84%</b><br><td nowrap>10730(1.3%) <b>79%</b><br>10828(2.2%) <b>79%</b><br>
</table>

