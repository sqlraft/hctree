
<title> Thread Test </title>

<h1>Project Status</h1>

This project contains no usable code. The database backend works well enough to
run some test cases, but (for example):

  *  modifying or deleting large records (> 1KiB for index records, or >4KiB
     for table records) leaks pages.
  *  DROP TABLE and DROP INDEX both leak database pages.
  *  very large transactions result in a database file that contains many
     unused pages.
  *  the "EDKS" feature, which prevents excess delete keys from accumlating
     as a result of an unfortunate sequence of writes and deletes, is not
     implemented.
  *  it is not possible to change the database page size.
  *  there are surely many bugs.

Even so, the prototype is advanced enough to use to test whether or not
multiple writers really can run concurrently on multi-processor systems.
That is the goal of the tests on this page - to verify the extent that
the database allows multiple clients in separate application threads to
run concurrent read/write transactions.

<h1>Test Overview</h1>

All tests use the same database. The schema is:

<pre>
      CREATE TABLE tbl(
         a INTEGER PRIMARY KEY,
         b BLOB(200),
         c CHAR(64)
      );
      CREATE INDEX tbl_i1 ON tbl(substr(c, 1, 16));
      CREATE INDEX tbl_i2 ON tbl(substr(c, 2, 16));
</pre>

The initial database contains 1,000,000 rows. Column "a" contains values
1 to 1,000,000. Column "b" contains a 200 byte blob value. Column "c"
contains a 64 byte text value.

Each test consists of between 1 and 8 threads, all running transactions
as fast as possible for 30 seconds. Each transaction consists of:

<pre>
      BEGIN;
        -- repeat <i>nScan</i> times:
        SELECT * FROM tbl WHERE substr(c, 1, 16)>=hex(frandomblob(8)) ORDER BY substr(c, 1, 16) LIMIT 10;
</pre>
<pre>
        -- repeat <i>nUpdate</i> times:
        UPDATE tbl SET b=updateblob(b, ?, ?), c=hex(frandomblob(32)) WHERE a = ?;
      COMMIT;
</pre>

Where <i>nScan</i> and <i>nUpdate</i> are parameters for the test.

As well as tests using hctree with between 1 and 8 client threads, tests
are also run against stock SQLite using a single client and thread. For
these tests, SQLite is configured with the following:

<pre>
      PRAGMA journal_mode = wal";
      PRAGMA wal_autocheckpoint = 10000";
      PRAGMA mmap_size = 1000000000";
      PRAGMA locking_mode = exclusive;
      PRAGMA synchronous = off;
</pre>

<h1>Test Results</h1>

Each cell of the table below contains results for two test runs. For
each test run, three values are reported:

  *  the total number of transactions per second, 
  *  the percentage of these transactions that failed with SQLITE_BUSY (in
     parenthesis), and
  *  the per-cpu speed that this represents, relative to the single threaded
     case, as a percentage (in bold).

For example, the first run of the 8 thread test with nUpdate=1 and nScan=0
is reported as "240288 (0.0%) <b>82%</b>". This means that, considering all
8 threads, throughput was 240288 transactions per second. This is 30036 per
second for each CPU, or roughly 82% of the average speed of the single
threaded tests - 36249 transactions per second. None (or perhaps almost none)
of these failed to COMMIT, hence the "(0.0%)".



<table border=1 cellpadding=10><tr><th>Test<th>stock<th>1<th>2<th>4<th>6<th>8
<tr><td>-nup 1 -nscan 0 -sep 1
<td><td>36409&nbsp;(0.0%)&nbsp;<b>100%</b><br>36307&nbsp;(0.0%)&nbsp;<b>99%</b><br><td>73974&nbsp;(0.0%)&nbsp;<b>101%</b><br>72889&nbsp;(0.0%)&nbsp;<b>100%</b><br><td>131326&nbsp;(0.0%)&nbsp;<b>90%</b><br>131405&nbsp;(0.0%)&nbsp;<b>90%</b><br><td>180676&nbsp;(0.0%)&nbsp;<b>82%</b><br>180083&nbsp;(0.0%)&nbsp;<b>82%</b><br><td>222419&nbsp;(0.0%)&nbsp;<b>76%</b><br>220940&nbsp;(0.0%)&nbsp;<b>75%</b><br>
<tr><td>-nup 5 -nscan 0 -sep 1
<td><td>7805&nbsp;(0.0%)&nbsp;<b>97%</b><br>8158&nbsp;(0.0%)&nbsp;<b>102%</b><br><td>16517&nbsp;(0.0%)&nbsp;<b>103%</b><br>16433&nbsp;(0.0%)&nbsp;<b>102%</b><br><td>28798&nbsp;(0.0%)&nbsp;<b>90%</b><br>28633&nbsp;(0.0%)&nbsp;<b>89%</b><br><td>38798&nbsp;(0.0%)&nbsp;<b>81%</b><br>38791&nbsp;(0.0%)&nbsp;<b>81%</b><br><td>47397&nbsp;(0.0%)&nbsp;<b>74%</b><br>47370&nbsp;(0.0%)&nbsp;<b>74%</b><br>
<tr><td>-nup 25 -nscan 0 -sep 1
<td><td>1674&nbsp;(0.0%)&nbsp;<b>100%</b><br>1655&nbsp;(0.0%)&nbsp;<b>99%</b><br><td>3402&nbsp;(0.0%)&nbsp;<b>102%</b><br>3412&nbsp;(0.0%)&nbsp;<b>102%</b><br><td>5970&nbsp;(0.0%)&nbsp;<b>89%</b><br>5854&nbsp;(0.0%)&nbsp;<b>87%</b><br><td>7939&nbsp;(0.0%)&nbsp;<b>79%</b><br>7978&nbsp;(0.0%)&nbsp;<b>79%</b><br><td>9686&nbsp;(0.0%)&nbsp;<b>72%</b><br>9624&nbsp;(0.0%)&nbsp;<b>72%</b><br>
<tr><td>-nup 1 -nscan 0
<td>30903&nbsp;(0.0%)&nbsp;<b>85%</b><br>31169&nbsp;(0.0%)&nbsp;<b>85%</b><br><td>36355&nbsp;(0.0%)&nbsp;<b>100%</b><br>36144&nbsp;(0.0%)&nbsp;<b>99%</b><br><td>72476&nbsp;(0.0%)&nbsp;<b>99%</b><br>71953&nbsp;(0.0%)&nbsp;<b>99%</b><br><td>134744&nbsp;(0.0%)&nbsp;<b>92%</b><br>133601&nbsp;(0.0%)&nbsp;<b>92%</b><br><td>188879&nbsp;(0.0%)&nbsp;<b>86%</b><br>187915&nbsp;(0.0%)&nbsp;<b>86%</b><br><td>240288&nbsp;(0.0%)&nbsp;<b>82%</b><br>238308&nbsp;(0.0%)&nbsp;<b>82%</b><br>
<tr><td>-nup 5 -nscan 0
<td>6362&nbsp;(0.0%)&nbsp;<b>78%</b><br>6387&nbsp;(0.0%)&nbsp;<b>78%</b><br><td>8162&nbsp;(0.0%)&nbsp;<b>100%</b><br>8093&nbsp;(0.0%)&nbsp;<b>99%</b><br><td>16285&nbsp;(0.0%)&nbsp;<b>100%</b><br>16035&nbsp;(0.0%)&nbsp;<b>98%</b><br><td>30269&nbsp;(0.0%)&nbsp;<b>93%</b><br>30272&nbsp;(0.0%)&nbsp;<b>93%</b><br><td>42315&nbsp;(0.1%)&nbsp;<b>86%</b><br>42078&nbsp;(0.1%)&nbsp;<b>86%</b><br><td>52482&nbsp;(0.1%)&nbsp;<b>80%</b><br>52214&nbsp;(0.0%)&nbsp;<b>80%</b><br>
<tr><td>-nup 25 -nscan 0
<td>1301&nbsp;(0.0%)&nbsp;<b>78%</b><br>1297&nbsp;(0.0%)&nbsp;<b>77%</b><br><td>1680&nbsp;(0.0%)&nbsp;<b>100%</b><br>1655&nbsp;(0.0%)&nbsp;<b>99%</b><br><td>3390&nbsp;(1.7%)&nbsp;<b>101%</b><br>3380&nbsp;(0.1%)&nbsp;<b>101%</b><br><td>6191&nbsp;(0.2%)&nbsp;<b>92%</b><br>6192&nbsp;(1.0%)&nbsp;<b>92%</b><br><td>8630&nbsp;(2.0%)&nbsp;<b>86%</b><br>8734&nbsp;(2.0%)&nbsp;<b>87%</b><br><td>10935&nbsp;(3.0%)&nbsp;<b>81%</b><br>11011&nbsp;(3.1%)&nbsp;<b>82%</b><br>
<tr><td>-nup 1 -nscan 5
<td>10082&nbsp;(0.0%)&nbsp;<b>95%</b><br>9885&nbsp;(0.0%)&nbsp;<b>93%</b><br><td>10693&nbsp;(0.0%)&nbsp;<b>100%</b><br>10488&nbsp;(0.0%)&nbsp;<b>99%</b><br><td>22584&nbsp;(0.1%)&nbsp;<b>106%</b><br>21871&nbsp;(0.1%)&nbsp;<b>103%</b><br><td>43689&nbsp;(0.1%)&nbsp;<b>103%</b><br>43831&nbsp;(0.1%)&nbsp;<b>103%</b><br><td>63426&nbsp;(0.2%)&nbsp;<b>99%</b><br>63612&nbsp;(0.2%)&nbsp;<b>100%</b><br><td>82865&nbsp;(0.3%)&nbsp;<b>97%</b><br>82235&nbsp;(0.2%)&nbsp;<b>97%</b><br>
<tr><td>-nup 5 -nscan 10
<td>3395&nbsp;(0.0%)&nbsp;<b>89%</b><br>3303&nbsp;(0.0%)&nbsp;<b>87%</b><br><td>3896&nbsp;(0.0%)&nbsp;<b>102%</b><br>3691&nbsp;(0.0%)&nbsp;<b>97%</b><br><td>8050&nbsp;(0.6%)&nbsp;<b>106%</b><br>8002&nbsp;(0.8%)&nbsp;<b>105%</b><br><td>15427&nbsp;(1.8%)&nbsp;<b>101%</b><br>15293&nbsp;(1.4%)&nbsp;<b>100%</b><br><td>22027&nbsp;(1.8%)&nbsp;<b>96%</b><br>21938&nbsp;(2.1%)&nbsp;<b>96%</b><br><td>27746&nbsp;(2.0%)&nbsp;<b>91%</b><br>27842&nbsp;(2.3%)&nbsp;<b>91%</b><br>
</table>


