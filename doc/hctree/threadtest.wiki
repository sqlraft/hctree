
<title> Thread Test </title>

<h1>Project Status</h1>

This project contains no usable code. The database backend works well enough to
run some test cases, but (for example):

  *  modifying or deleting large records (> 1KiB for index records, or >4KiB
     for table records) leaks pages.
  *  DROP TABLE and DROP INDEX both leak database pages.
  *  very large transactions result in a database file that contains many
     unused pages.
  *  the "EDKS" feature, which prevents excess delete keys from accumlating
     as a result of an unfortunate sequence of writes and deletes, is not
     implemented.
  *  it is not possible to change the database page size.
  *  there are surely many bugs.

Even so, the prototype is advanced enough to use to test whether or not
multiple writers really can run concurrently on multi-processor systems.
That is the goal of the tests on this page - to verify the extent that
the database allows multiple clients in separate application threads to
run concurrent read/write transactions.

<h1>Test Overview</h1>

All tests use the same database. The schema is:

<pre>
      CREATE TABLE tbl(
         a INTEGER PRIMARY KEY,
         b BLOB(200),
         c CHAR(64)
      );
      CREATE INDEX tbl_i1 ON tbl(substr(c, 1, 16));
      CREATE INDEX tbl_i2 ON tbl(substr(c, 2, 16));
</pre>

The initial database contains 1,000,000 rows. Column "a" contains values
1 to 1,000,000. Column "b" contains a 200 byte blob value. Column "c"
contains a 64 byte text value.

Each test consists of between 1 and 8 threads, all running transactions
as fast as possible for 30 seconds. Each transaction consists of:

<pre>
      BEGIN;
        -- repeat <i>nScan</i> times:
        SELECT * FROM tbl WHERE substr(c, 1, 16)>=hex(frandomblob(8)) ORDER BY substr(c, 1, 16) LIMIT 10;
</pre>
<pre>
        -- repeat <i>nUpdate</i> times:
        UPDATE tbl SET b=updateblob(b, ?, ?), c=hex(frandomblob(32)) WHERE a = ?;
      COMMIT;
</pre>

Where <i>nScan</i> and <i>nUpdate</i> are parameters for the test.

As well as tests using hctree with between 1 and 8 client threads, tests
are also run against stock SQLite using a single client and thread. For
these tests, SQLite is configured with the following:

<pre>
      PRAGMA journal_mode = wal";
      PRAGMA wal_autocheckpoint = 10000";
      PRAGMA mmap_size = 1000000000";
      PRAGMA locking_mode = exclusive;
      PRAGMA synchronous = off;
</pre>

<h1>Test Results</h1>

Each cell of the table below contains results for two test runs. For
each test run, three values are reported:

  *  the total number of transactions per second, 
  *  the percentage of these transactions that failed with SQLITE_BUSY (in
     parenthesis), and
  *  the per-cpu speed that this represents, relative to the single threaded
     case, as a percentage (in bold).

For example, the first run of the 8 thread test with nUpdate=1 and nScan=0
is reported as "243832 (0.0%) <b>85%</b>". This means that, considering all
8 threads, throughput was 243832 transactions per second. This is 30479 per
second for each CPU, or roughly 85% of the average speed of the single
threaded tests - 35897 transactions per second. None (or perhaps almost none)
of these failed to COMMIT, hence the "(0.0%)".

<table border=1 cellpadding=10><tr><th>Test<th>Stock SQLite<th>HCT 1 thread<th>HCT 2 threads<th>HCT 4 threads<th>HCT 6 threads<th>HCT 8 threads
<tr><td>nUpdate=0 nScan=1
<td>82004(0.0%)&nbsp<b>103%</b><br>72870(0.0%)&nbsp<b>92%</b><br><td>80079(0.0%)&nbsp<b>101%</b><br>79062(0.0%)&nbsp<b>99%</b><br><td>171610(0.0%)&nbsp<b>108%</b><br>169548(0.0%)&nbsp<b>107%</b><br><td>342761(0.0%)&nbsp<b>108%</b><br>339859(0.0%)&nbsp<b>107%</b><br><td>505376(0.0%)&nbsp<b>106%</b><br>505464(0.0%)&nbsp<b>106%</b><br><td>639161(0.0%)&nbsp<b>100%</b><br>665236(0.0%)&nbsp<b>105%</b><br>
<tr><td>nUpdate=0 nScan=5
<td>17536(0.0%)&nbsp<b>110%</b><br>16876(0.0%)&nbsp<b>106%</b><br><td>15495(0.0%)&nbsp<b>98%</b><br>16269(0.0%)&nbsp<b>102%</b><br><td>35380(0.0%)&nbsp<b>111%</b><br>34304(0.0%)&nbsp<b>108%</b><br><td>69239(0.0%)&nbsp<b>109%</b><br>69072(0.0%)&nbsp<b>109%</b><br><td>103414(0.0%)&nbsp<b>109%</b><br>102711(0.0%)&nbsp<b>108%</b><br><td>135803(0.0%)&nbsp<b>107%</b><br>135101(0.0%)&nbsp<b>106%</b><br>
<tr><td>nUpdate=0 nScan=10
<td>8865(0.0%)&nbsp<b>112%</b><br>8665(0.0%)&nbsp<b>109%</b><br><td>7794(0.0%)&nbsp<b>98%</b><br>8064(0.0%)&nbsp<b>102%</b><br><td>17385(0.0%)&nbsp<b>110%</b><br>17599(0.0%)&nbsp<b>111%</b><br><td>34687(0.0%)&nbsp<b>109%</b><br>34645(0.0%)&nbsp<b>109%</b><br><td>51502(0.0%)&nbsp<b>108%</b><br>51544(0.0%)&nbsp<b>108%</b><br><td>67946(0.0%)&nbsp<b>107%</b><br>67585(0.0%)&nbsp<b>107%</b><br>
<tr><td>nUpdate=0 nScan=25
<td>3622(0.0%)&nbsp<b>111%</b><br>3497(0.0%)&nbsp<b>108%</b><br><td>3256(0.0%)&nbsp<b>100%</b><br>3244(0.0%)&nbsp<b>100%</b><br><td>7053(0.0%)&nbsp<b>109%</b><br>6965(0.0%)&nbsp<b>107%</b><br><td>13837(0.0%)&nbsp<b>106%</b><br>13879(0.0%)&nbsp<b>107%</b><br><td>20663(0.0%)&nbsp<b>106%</b><br>20449(0.0%)&nbsp<b>105%</b><br><td>27174(0.0%)&nbsp<b>105%</b><br>26951(0.0%)&nbsp<b>104%</b><br>
<tr><td>nUpdate=1 nScan=0
<td>28615(0.0%)&nbsp<b>80%</b><br>30457(0.0%)&nbsp<b>85%</b><br><td>35261(0.0%)&nbsp<b>98%</b><br>36533(0.0%)&nbsp<b>102%</b><br><td>71853(0.0%)&nbsp<b>100%</b><br>73132(0.0%)&nbsp<b>102%</b><br><td>135924(0.0%)&nbsp<b>95%</b><br>137546(0.0%)&nbsp<b>96%</b><br><td>191311(0.0%)&nbsp<b>89%</b><br>193415(0.0%)&nbsp<b>90%</b><br><td>243832(0.0%)&nbsp<b>85%</b><br>244235(0.0%)&nbsp<b>85%</b><br>
<tr><td>nUpdate=1 nScan=1
<td>21165(0.0%)&nbsp<b>91%</b><br>20946(0.0%)&nbsp<b>91%</b><br><td>22944(0.0%)&nbsp<b>99%</b><br>23329(0.0%)&nbsp<b>101%</b><br><td>48754(0.0%)&nbsp<b>105%</b><br>48548(0.0%)&nbsp<b>105%</b><br><td>92544(0.0%)&nbsp<b>100%</b><br>92709(0.0%)&nbsp<b>100%</b><br><td>131705(0.0%)&nbsp<b>95%</b><br>132066(0.0%)&nbsp<b>95%</b><br><td>167619(0.0%)&nbsp<b>91%</b><br>167153(0.0%)&nbsp<b>90%</b><br>
<tr><td>nUpdate=1 nScan=5
<td>9982(0.0%)&nbsp<b>93%</b><br>9801(0.0%)&nbsp<b>92%</b><br><td>10808(0.0%)&nbsp<b>101%</b><br>10545(0.0%)&nbsp<b>99%</b><br><td>22129(0.0%)&nbsp<b>104%</b><br>22157(0.0%)&nbsp<b>104%</b><br><td>43371(0.1%)&nbsp<b>102%</b><br>43353(0.1%)&nbsp<b>102%</b><br><td>63466(0.1%)&nbsp<b>99%</b><br>63314(0.1%)&nbsp<b>99%</b><br><td>81691(0.2%)&nbsp<b>96%</b><br>81585(0.1%)&nbsp<b>96%</b><br>
<tr><td>nUpdate=1 nScan=10
<td>6119(0.0%)&nbsp<b>98%</b><br>6031(0.0%)&nbsp<b>96%</b><br><td>6401(0.0%)&nbsp<b>102%</b><br>6140(0.0%)&nbsp<b>98%</b><br><td>13391(0.0%)&nbsp<b>107%</b><br>13272(0.0%)&nbsp<b>106%</b><br><td>26424(0.1%)&nbsp<b>105%</b><br>26407(0.1%)&nbsp<b>105%</b><br><td>38758(0.2%)&nbsp<b>103%</b><br>38575(0.2%)&nbsp<b>103%</b><br><td>50137(0.3%)&nbsp<b>100%</b><br>50229(0.3%)&nbsp<b>100%</b><br>
<tr><td>nUpdate=1 nScan=25
<td>2845(0.0%)&nbsp<b>99%</b><br>2814(0.0%)&nbsp<b>98%</b><br><td>2890(0.0%)&nbsp<b>100%</b><br>2878(0.0%)&nbsp<b>100%</b><br><td>6149(0.1%)&nbsp<b>107%</b><br>6020(0.1%)&nbsp<b>104%</b><br><td>12049(0.4%)&nbsp<b>104%</b><br>12060(0.3%)&nbsp<b>105%</b><br><td>17887(0.6%)&nbsp<b>103%</b><br>17763(0.5%)&nbsp<b>103%</b><br><td>23238(0.7%)&nbsp<b>101%</b><br>23255(0.7%)&nbsp<b>101%</b><br>
<tr><td>nUpdate=5 nScan=0
<td>6272(0.0%)&nbsp<b>79%</b><br>5356(0.0%)&nbsp<b>67%</b><br><td>7933(0.0%)&nbsp<b>100%</b><br>7952(0.0%)&nbsp<b>100%</b><br><td>16296(0.1%)&nbsp<b>103%</b><br>16119(0.0%)&nbsp<b>101%</b><br><td>29610(0.0%)&nbsp<b>93%</b><br>29951(0.0%)&nbsp<b>94%</b><br><td>41564(0.0%)&nbsp<b>87%</b><br>41336(0.0%)&nbsp<b>87%</b><br><td>52039(0.1%)&nbsp<b>82%</b><br>51911(0.1%)&nbsp<b>82%</b><br>
<tr><td>nUpdate=5 nScan=1
<td>5636(0.0%)&nbsp<b>81%</b><br>5574(0.0%)&nbsp<b>80%</b><br><td>7094(0.0%)&nbsp<b>102%</b><br>6863(0.0%)&nbsp<b>98%</b><br><td>14141(0.0%)&nbsp<b>101%</b><br>14169(0.0%)&nbsp<b>102%</b><br><td>26547(0.1%)&nbsp<b>95%</b><br>26486(0.1%)&nbsp<b>95%</b><br><td>37345(0.2%)&nbsp<b>89%</b><br>37120(0.2%)&nbsp<b>89%</b><br><td>46619(0.3%)&nbsp<b>84%</b><br>46813(0.3%)&nbsp<b>84%</b><br>
<tr><td>nUpdate=5 nScan=5
<td>4219(0.0%)&nbsp<b>83%</b><br>4206(0.0%)&nbsp<b>83%</b><br><td>5082(0.0%)&nbsp<b>100%</b><br>5071(0.0%)&nbsp<b>100%</b><br><td>10341(0.1%)&nbsp<b>102%</b><br>10413(0.1%)&nbsp<b>103%</b><br><td>19793(0.4%)&nbsp<b>97%</b><br>19897(0.5%)&nbsp<b>98%</b><br><td>28063(0.7%)&nbsp<b>92%</b><br>27953(0.7%)&nbsp<b>92%</b><br><td>35196(1.0%)&nbsp<b>87%</b><br>35100(0.9%)&nbsp<b>86%</b><br>
<tr><td>nUpdate=5 nScan=10
<td>3284(0.0%)&nbsp<b>86%</b><br>3320(0.0%)&nbsp<b>87%</b><br><td>3822(0.0%)&nbsp<b>100%</b><br>3792(0.0%)&nbsp<b>100%</b><br><td>7999(0.2%)&nbsp<b>105%</b><br>8010(0.2%)&nbsp<b>105%</b><br><td>15204(0.6%)&nbsp<b>100%</b><br>15116(0.6%)&nbsp<b>99%</b><br><td>21713(1.2%)&nbsp<b>95%</b><br>21711(1.3%)&nbsp<b>95%</b><br><td>27515(1.7%)&nbsp<b>90%</b><br>27414(1.6%)&nbsp<b>90%</b><br>
<tr><td>nUpdate=5 nScan=25
<td>2025(0.0%)&nbsp<b>92%</b><br>2016(0.0%)&nbsp<b>91%</b><br><td>2203(0.0%)&nbsp<b>100%</b><br>2204(0.0%)&nbsp<b>100%</b><br><td>4552(0.5%)&nbsp<b>103%</b><br>4627(0.5%)&nbsp<b>105%</b><br><td>8993(1.6%)&nbsp<b>102%</b><br>8960(1.5%)&nbsp<b>102%</b><br><td>13070(2.5%)&nbsp<b>99%</b><br>13093(2.5%)&nbsp<b>99%</b><br><td>16776(3.5%)&nbsp<b>95%</b><br>16742(3.7%)&nbsp<b>95%</b><br>
<tr><td>nUpdate=10 nScan=0
<td>2992(0.0%)&nbsp<b>74%</b><br>2926(0.0%)&nbsp<b>73%</b><br><td>4075(0.0%)&nbsp<b>101%</b><br>3992(0.0%)&nbsp<b>99%</b><br><td>8211(0.0%)&nbsp<b>102%</b><br>8261(0.0%)&nbsp<b>102%</b><br><td>15120(0.3%)&nbsp<b>94%</b><br>15184(0.0%)&nbsp<b>94%</b><br><td>21217(0.4%)&nbsp<b>88%</b><br>21104(0.4%)&nbsp<b>87%</b><br><td>26436(0.2%)&nbsp<b>82%</b><br>26336(0.2%)&nbsp<b>82%</b><br>
<tr><td>nUpdate=10 nScan=1
<td>2942(0.0%)&nbsp<b>78%</b><br>2914(0.0%)&nbsp<b>77%</b><br><td>3732(0.0%)&nbsp<b>99%</b><br>3799(0.0%)&nbsp<b>101%</b><br><td>7787(0.1%)&nbsp<b>103%</b><br>7619(0.3%)&nbsp<b>101%</b><br><td>14243(0.2%)&nbsp<b>95%</b><br>14191(0.2%)&nbsp<b>94%</b><br><td>19894(0.6%)&nbsp<b>88%</b><br>19848(0.5%)&nbsp<b>88%</b><br><td>24810(0.6%)&nbsp<b>82%</b><br>24813(0.7%)&nbsp<b>82%</b><br>
<tr><td>nUpdate=10 nScan=5
<td>2534(0.0%)&nbsp<b>82%</b><br>2529(0.0%)&nbsp<b>81%</b><br><td>3111(0.0%)&nbsp<b>100%</b><br>3099(0.0%)&nbsp<b>100%</b><br><td>6328(0.3%)&nbsp<b>102%</b><br>6302(0.3%)&nbsp<b>101%</b><br><td>11899(0.9%)&nbsp<b>96%</b><br>11952(1.3%)&nbsp<b>96%</b><br><td>16661(1.3%)&nbsp<b>89%</b><br>16703(1.4%)&nbsp<b>90%</b><br><td>20922(2.4%)&nbsp<b>84%</b><br>20865(2.0%)&nbsp<b>84%</b><br>
<tr><td>nUpdate=10 nScan=10
<td>2179(0.0%)&nbsp<b>85%</b><br>2074(0.0%)&nbsp<b>81%</b><br><td>2595(0.0%)&nbsp<b>101%</b><br>2538(0.0%)&nbsp<b>99%</b><br><td>5231(0.7%)&nbsp<b>102%</b><br>5229(0.4%)&nbsp<b>102%</b><br><td>10048(1.6%)&nbsp<b>98%</b><br>10022(1.5%)&nbsp<b>98%</b><br><td>14075(2.6%)&nbsp<b>91%</b><br>14073(2.5%)&nbsp<b>91%</b><br><td>17637(3.9%)&nbsp<b>86%</b><br>17612(3.3%)&nbsp<b>86%</b><br>
<tr><td>nUpdate=10 nScan=25
<td>1521(0.0%)&nbsp<b>89%</b><br>1473(0.0%)&nbsp<b>86%</b><br><td>1712(0.0%)&nbsp<b>101%</b><br>1694(0.0%)&nbsp<b>99%</b><br><td>3555(1.0%)&nbsp<b>104%</b><br>3584(1.0%)&nbsp<b>105%</b><br><td>6846(3.3%)&nbsp<b>100%</b><br>6826(3.5%)&nbsp<b>100%</b><br><td>9745(5.7%)&nbsp<b>95%</b><br>9718(5.5%)&nbsp<b>95%</b><br><td>12342(7.6%)&nbsp<b>91%</b><br>12285(7.8%)&nbsp<b>90%</b><br>
<tr><td>nUpdate=25 nScan=0
<td>1271(0.0%)&nbsp<b>78%</b><br>1184(0.0%)&nbsp<b>73%</b><br><td>1664(0.0%)&nbsp<b>102%</b><br>1594(0.0%)&nbsp<b>98%</b><br><td>3278(0.1%)&nbsp<b>101%</b><br>3332(0.1%)&nbsp<b>102%</b><br><td>6180(1.1%)&nbsp<b>95%</b><br>6169(1.1%)&nbsp<b>95%</b><br><td>8670(2.6%)&nbsp<b>89%</b><br>8523(0.9%)&nbsp<b>87%</b><br><td>10688(2.2%)&nbsp<b>82%</b><br>10773(3.1%)&nbsp<b>83%</b><br>
</table>


