# 2022 November 16
#
# The author disclaims copyright to this source code.  In place of
# a legal notice, here is a blessing:
#
#    May you do good and not evil.
#    May you find forgiveness for yourself and forgive others.
#    May you share freely, never taking more than you give.
#
#*************************************************************************
# This file implements regression tests for SQLite library.
#

set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix hct_index6

# Setup for logging 
db close
sqlite3_shutdown
#sqlite_log_to_stdout
autoinstall_test_functions

expr srand(0)
#set hct_extra_write_logging 1

hct_reset_db

do_execsql_test 1.0 {
  BEGIN;
    CREATE TABLE t1(a INTEGER PRIMARY KEY, b TEXT);
    INSERT INTO t1 VALUES (10, hex(randomblob(350)));
    INSERT INTO t1 VALUES (20, hex(randomblob(350)));
    INSERT INTO t1 VALUES (30, hex(randomblob(350)));
    INSERT INTO t1 VALUES (40, hex(randomblob(350)));
    INSERT INTO t1 VALUES (50, hex(randomblob(350)));
    INSERT INTO t1 VALUES (60, hex(randomblob(350)));
    INSERT INTO t1 VALUES (70, hex(randomblob(350)));
    INSERT INTO t1 VALUES (80, hex(randomblob(350)));
    INSERT INTO t1 VALUES (90, hex(randomblob(350)));
    INSERT INTO t1 VALUES (100, hex(randomblob(350)));
  COMMIT;
}

sqlite3 db2 test.db
do_execsql_test -db db2 1.1 {
  BEGIN;
  SELECT a FROM t1
} {
  10 20 30 40 50 60 70 80 90 100
}

do_execsql_test 1.2 {
  BEGIN;
    DELETE FROM t1 WHERE a>=30;
  COMMIT;
  BEGIN;
    INSERT INTO t1 VALUES(85, hex(randomblob(350)));
    INSERT INTO t1 VALUES(90, hex(randomblob(350)));
    INSERT INTO t1 VALUES(95, hex(randomblob(350)));
    INSERT INTO t1 VALUES(100, hex(randomblob(350)));
    INSERT INTO t1 VALUES(105, hex(randomblob(350)));
    INSERT INTO t1 VALUES(110, hex(randomblob(350)));
  COMMIT;
}

if 1 {
execsql { PRAGMA hct_extra_logging = 2 } db2
do_execsql_test -db db2 1.3 {
  SELECT a FROM t1 WHERE a>=102
} {}
execsql { PRAGMA hct_extra_logging = 0 } db2
foreach ln [split [db2 eval {PRAGMA hct_log}] "\n"] {
  puts "log: $ln"
}
}

execsql_pp { SELECT * FROM hcttmap }
show_pagemap
show_all_entries

finish_test


