# 2025 April 18
#
# The author disclaims copyright to this source code.  In place of
# a legal notice, here is a blessing:
#
#    May you do good and not evil.
#    May you find forgiveness for yourself and forgive others.
#    May you share freely, never taking more than you give.
#
#*************************************************************************
# This file implements regression tests for SQLite library.
#

set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix hct_index3

# Setup for logging 
db close
#sqlite3_shutdown
#sqlite_log_to_stdout

hct_reset_db

proc rand {min max} {
  expr {$min + int(abs(rand() * (1 + $max - $min)))}
}
db func rand rand

proc randtext {n} {
  set char [list a B c D e F g H i J k L m N o P q R s T u V w X y Z]
  set ret ""
  for {set ii 0} {$ii<$n} {incr ii} {
    append ret [lindex $char [rand 0 [llength $char]]]
  }
  set ret
}
db func randtext randtext

set NROW [expr 20]

expr srand(0)

do_execsql_test 1.0 {
  PRAGMA page_size = 512;
  CREATE TABLE t1(ii INTEGER PRIMARY KEY, a INTEGER, b TEXT);
  CREATE INDEX i1 ON t1(a, b);
  INSERT INTO t1(ii, a, b) VALUES(0, 50, 'text');
  INSERT INTO t1(ii, a, b) VALUES(-1, 500, 'text');
}

do_execsql_test 1.1 {
  BEGIN;
    INSERT INTO t1(a, b) VALUES(100, 'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa');
    INSERT INTO t1(a, b) VALUES(100, 'bbbbbbbbbbbbbbbbbbbbbbbbbbbbbb');
    INSERT INTO t1(a, b) VALUES(100, 'cccccccccccccccccccccccccccccc');
    INSERT INTO t1(a, b) VALUES(101, 'dddddddddddddddddddddddddddddd');
    INSERT INTO t1(a, b) VALUES(101, 'eeeeeeeeeeeeeeeeeeeeeeeeeeeeee');
    INSERT INTO t1(a, b) VALUES(101, 'ffffffffffffffffffffffffffffff');
    INSERT INTO t1(a, b) VALUES(102, 'gggggggggggggggggggggggggggggg');
    INSERT INTO t1(a, b) VALUES(102, 'hhhhhhhhhhhhhhhhhhhhhhhhhhhhhh');
    INSERT INTO t1(a, b) VALUES(102, 'iiiiiiiiiiiiiiiiiiiiiiiiiiiiii');
    INSERT INTO t1(a, b) VALUES(103, 'jjjjjjjjjjjjjjjjjjjjjjjjjjjjjj');
    INSERT INTO t1(a, b) VALUES(103, 'kkkkkkkkkkkkkkkkkkkkkkkkkkkkkk');
    INSERT INTO t1(a, b) VALUES(103, 'llllllllllllllllllllllllllllll');
    INSERT INTO t1(a, b) VALUES(104, 'mmmmmmmmmmmmmmmmmmmmmmmmmmmmmm');
    INSERT INTO t1(a, b) VALUES(104, 'nnnnnnnnnnnnnnnnnnnnnnnnnnnnnn');
    INSERT INTO t1(a, b) VALUES(104, 'oooooooooooooooooooooooooooooo');
    INSERT INTO t1(a, b) VALUES(105, 'pppppppppppppppppppppppppppppp');
    INSERT INTO t1(a, b) VALUES(105, 'qqqqqqqqqqqqqqqqqqqqqqqqqqqqqq');
    INSERT INTO t1(a, b) VALUES(105, 'rrrrrrrrrrrrrrrrrrrrrrrrrrrrrr');
    INSERT INTO t1(a, b) VALUES(106, 'ssssssssssssssssssssssssssssss');
    INSERT INTO t1(a, b) VALUES(106, 'tttttttttttttttttttttttttttttt');
    INSERT INTO t1(a, b) VALUES(107, 'uuuuuuuuuuuuuuuuuuuuuuuuuuuuuu');
    INSERT INTO t1(a, b) VALUES(107, 'vvvvvvvvvvvvvvvvvvvvvvvvvvvvvv');
    INSERT INTO t1(a, b) VALUES(107, 'wwwwwwwwwwwwwwwwwwwwwwwwwwwwww');
    INSERT INTO t1(a, b) VALUES(108, 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx');
    INSERT INTO t1(a, b) VALUES(108, 'yyyyyyyyyyyyyyyyyyyyyyyyyyyyyy');
    INSERT INTO t1(a, b) VALUES(108, 'zzzzzzzzzzzzzzzzzzzzzzzzzzzzzz');
  COMMIT;
}

do_execsql_test 1.2.1 {
  SELECT * FROM t1 WHERE a=102 AND b='gggggggggggggggggggggggggggggg';
} {7 102 gggggggggggggggggggggggggggggg}

do_execsql_test 1.2.2 {
  SELECT * FROM t1 
  WHERE a=102 AND b IN ('AAAA', 'gggggggggggggggggggggggggggggg');
} {7 102 gggggggggggggggggggggggggggggg}

do_execsql_test 1.3 {
  BEGIN;
    DELETE FROM t1 WHERE ii=9;
    SELECT * FROM t1 
      WHERE a=102 AND b IN ('AAAA', 'gggggggggggggggggggggggggggggg');
  ROLLBACK;
} {7 102 gggggggggggggggggggggggggggggg}

for {set iDel 1} {$iDel<=26} {incr iDel} {
  execsql BEGIN
  execsql { DELETE FROM t1 WHERE ii=$iDel }

  set tn 1
  foreach {ii a b} [execsql { SELECT ii, a, b FROM t1 }] {
    do_execsql_test 1.4.$iDel.$tn {
      SELECT * FROM t1 WHERE a = $a AND b IN ('AAAA', $b)
    } [list $ii $a $b]
    incr tn
  }

  execsql ROLLBACK
}

#-------------------------------------------------------------------------
hct_reset_db

do_execsql_test 2.0 {
  BEGIN;
    CREATE TABLE t2(a INTEGER PRIMARY KEY, b, c);
    INSERT INTO t2 VALUES(1, 22, 45);
    INSERT INTO t2 VALUES(2, 22, 46);
    INSERT INTO t2 VALUES(3, 22, 47);
    CREATE INDEX i1 ON t2(b, c);
  COMMIT;
}

sqlite3 db2 test.db

do_execsql_test -db db2 2.1 {
  BEGIN;
    SELECT b, c FROM t2 WHERE b=22
} {22 45  22 46  22 47}

do_execsql_test 2.2 {
  DELETE FROM t2 WHERE a=1;
}

do_execsql_test -db db2 2.3 {
    SELECT b, c FROM t2 WHERE b=22
} {22 45  22 46  22 47}
set hct_extra_logging 0

#-------------------------------------------------------------------------
hct_reset_db

do_execsql_test 3.0 {
  BEGIN;
    CREATE TABLE t2(a INTEGER PRIMARY KEY, b);
    CREATE UNIQUE INDEX i2 ON t2(b);
    INSERT INTO t2 VALUES(1, 22);
    INSERT INTO t2 VALUES(2, 23);
    INSERT INTO t2 VALUES(3, 24);
  COMMIT;
}

do_execsql_test 3.1 {
  BEGIN;
    DELETE FROM t2 WHERE a=2; 
    INSERT INTO t2 VALUES(4, 23);
} {}

do_catchsql_test 3.2 {
  INSERT INTO t2 VALUES(5, 23);
} {1 {UNIQUE constraint failed: t2.b}}

do_execsql_test 3.3 {
  COMMIT
} 

#-------------------------------------------------------------------------
hct_reset_db

do_execsql_test 4.0 {
  BEGIN;
    CREATE TABLE t2(a INTEGER PRIMARY KEY, b NOT NULL, c);
    CREATE INDEX i2 ON t2(b, c);
    INSERT INTO t2 VALUES(1, 1, 1);
    INSERT INTO t2 VALUES(2, 1, 2);
    INSERT INTO t2 VALUES(3, 2, 1);
    INSERT INTO t2 VALUES(4, 2, 2);
  COMMIT;
}

do_execsql_test 4.1 {
  SELECT 2 IN (SELECT b FROM t2);
} {1}

do_execsql_test 4.2 {
  BEGIN;
    DELETE FROM t2 WHERE a=3;
    SELECT 2 IN (SELECT b FROM t2);
} {1}

#-------------------------------------------------------------------------
hct_reset_db
do_execsql_test 5.0 {
  BEGIN;
    CREATE TABLE t3(a INTEGER PRIMARY KEY, b TEXT, c TEXT);
    CREATE INDEX t3b ON t3(b);

    INSERT INTO t3 VALUES(1, 'one', 'i');
    INSERT INTO t3 VALUES(2, 'two', 'ii');
    INSERT INTO t3 VALUES(3, 'three', 'iii');
  COMMIT;
}

sqlite3 db2 test.db
do_execsql_test -db db2 5.1 {
  BEGIN;
    SELECT * FROM t3 WHERE b='two';
} {2 two ii}

do_execsql_test 5.2 {
  DELETE FROM t3 WHERE a = 2;
}

do_execsql_test -db db2 5.2 {
    SELECT * FROM t3 WHERE a=2
} {2 two ii}

do_execsql_test -db db2 5.3 {
    SELECT * FROM t3 WHERE b='two';
} {2 two ii}

#-------------------------------------------------------------------------
hct_reset_db
do_execsql_test 5.0 {
  BEGIN;
    CREATE TABLE t6(a INTEGER PRIMARY KEY, b TEXT);
    INSERT INTO t6 VALUES(1, 'hello');

    CREATE TABLE t5(a INTEGER PRIMARY KEY, b TEXT);
    CREATE INDEX t5b ON t5(b);
    WITH s(i) AS (
      SELECT 1 UNION ALL SELECT i+1 FROM s WHERE i<1000
    )
    INSERT INTO t5(b) SELECT randstr(100,100) FROM s;
  COMMIT;
}

do_execsql_test 5.1 {
  BEGIN;
    UPDATE t5 SET b=randstr(100,100) WHERE a=420;
    UPDATE t5 SET b=randstr(100,100) WHERE a=420;
  COMMIT;
}

sqlite3 db2 test.db

do_execsql_test 5.2 {
  BEGIN;
    UPDATE t5 SET b=randstr(100,100) WHERE a=420;
    SELECT * FROM t6;
} {1 hello}

do_test 5.3 {
  db2 eval { INSERT INTO t6 VALUES(2, 'two') }
} {}

do_catchsql_test 5.4 {
  COMMIT
} {1 {database is locked}}
execsql ROLLBACK

do_execsql_test 5.5 {
  PRAGMA hct_quiescent_integrity_check=1;
  PRAGMA integrity_check;
} {1 ok}
 

finish_test

