# 2021 January 01
#
# The author disclaims copyright to this source code.  In place of
# a legal notice, here is a blessing:
#
#    May you do good and not evil.
#    May you find forgiveness for yourself and forgive others.
#    May you share freely, never taking more than you give.
#
#*************************************************************************
# This file implements regression tests for SQLite library.
#

set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix hct_cas

for {set tn 0} {$tn < 20} {incr tn} {
  reset_db
  do_execsql_test 1.$tn.0 {
    CREATE TABLE t1(x INTEGER PRIMARY KEY, y);
  }
  sqlite3_hct_cas_failure $tn 0
  do_execsql_test 1.$tn.1 {
    BEGIN;
      INSERT INTO t1 VALUES(1, 'one');
      INSERT INTO t1 VALUES(2, 'two');
    COMMIT;
  }
  do_execsql_test 1.$tn.2 {
    SELECT * FROM t1
  } {1 one 2 two}
  sqlite3_hct_cas_failure 0 0
}

for {set tn 0} {$tn < 20} {incr tn} {
  reset_db
  do_execsql_test 2.$tn.0 {
    CREATE TABLE t1(x INTEGER PRIMARY KEY, y);
    WITH s(i) AS (
      SELECT 1 UNION ALL SELECT i+1 FROM s WHERE i<50
    )
    INSERT INTO t1 SELECT i+1, randomblob(500) FROM s;
  }
  sqlite3_hct_cas_failure $tn 0
  do_execsql_test 2.$tn.1 {
    BEGIN;
      INSERT INTO t1 VALUES(1, 'one');
      INSERT INTO t1 VALUES(52, 'fifty two');
    COMMIT;
  }
  do_execsql_test 2.$tn.2 {
    SELECT count(*), sum(x) FROM t1
  } [list 52 [expr 52*(52+1)/2]]
  sqlite3_hct_cas_failure 0 0
}



finish_test



