# 2021 June 1
#
# The author disclaims copyright to this source code.  In place of
# a legal notice, here is a blessing:
#
#    May you do good and not evil.
#    May you find forgiveness for yourself and forgive others.
#    May you share freely, never taking more than you give.
#
#*************************************************************************
# This file implements regression tests for SQLite library.
#

set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix hct_conflict2


proc do_sql_test {db tn sql {res {0 {}}} } {
  uplevel [subst {
    do_test $tn {
      catchsql { $sql } $db
    } {$res}
  }]
}

hct_reset_db
sqlite3 db2 test.db

do_execsql_test 1.0 {
  CREATE TABLE t1(a INTEGER PRIMARY KEY, b TEXT);
  INSERT INTO t1 VALUES(1, 'i');
  INSERT INTO t1 VALUES(2, 'ii');
  INSERT INTO t1 VALUES(3, 'iii');
}

proc func {} { 
  db2 eval $::func_sql
  set ::func_sql ""
  return 1 
}
db func func func

set ::func_sql {
  UPDATE t1 SET b='two' WHERE a=2
}

do_catchsql_test 1.1 {
  UPDATE t1 SET b=a WHERE func();
} {1 {database is locked}}

do_test 1.2 {
  sqlite3_extended_errcode db
} {SQLITE_BUSY_SNAPSHOT}

do_execsql_test 1.3 {
  SELECT * FROM t1
} {1 i 2 two 3 iii}

db2 close
#--------------------------------------------------------------------------

hct_reset_db
sqlite3 db2 test.db


do_sql_test db  2.0 {
  CREATE TABLE t1(a INTEGER PRIMARY KEY, b TEXT);
  INSERT INTO t1 VALUES(1, 'i');
  INSERT INTO t1 VALUES(2, 'ii');
  INSERT INTO t1 VALUES(3, 'iii');
}

do_sql_test db2 2.1 {
  BEGIN CONCURRENT;
    UPDATE t1 SET b=a+1;
}

do_sql_test db 2.2 { DELETE FROM t1 WHERE a=2 }

do_sql_test db2 2.3 {
  COMMIT
} {1 {database is locked}}

foreach {tn sql} {
  1 COMMIT
  2 "SELECT * FROM t1"
  3 "INSERT INTO t1 VALUES(10, 'ten')"
} {
  do_sql_test db2 2.4.$tn $sql {1 {database is locked}}
}
db2 eval ROLLBACK
db2 close


#--------------------------------------------------------------------------

hct_reset_db
sqlite3 db2 test.db


do_sql_test db 3.0 {
  CREATE TABLE t1(a INTEGER PRIMARY KEY, b TEXT);
  INSERT INTO t1 VALUES(1, 'i');
  INSERT INTO t1 VALUES(2, 'ii');
  INSERT INTO t1 VALUES(3, 'iii');
}

do_sql_test db 3.1 {
  BEGIN;
    INSERT INTO t1 VALUES(5, 'v');
  ROLLBACK;
}

do_sql_test db2 3.2 {
  INSERT INTO t1 VALUES(4, 'iv');
}

do_sql_test db 3.3 {
  SELECT * FROM t1
} {0 {1 i 2 ii 3 iii 4 iv}}

finish_test


