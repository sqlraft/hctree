# 2025 April 18
#
# The author disclaims copyright to this source code.  In place of
# a legal notice, here is a blessing:
#
#    May you do good and not evil.
#    May you find forgiveness for yourself and forgive others.
#    May you share freely, never taking more than you give.
#
#*************************************************************************
# This file implements regression tests for SQLite library.
#

set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix hct_index

# Setup for logging 
db close
sqlite3_shutdown
sqlite_log_to_stdout

hct_reset_db

do_execsql_test 1.0 {
  CREATE TABLE vals(
    ii INTEGER PRIMARY KEY,
    topic INTEGER,
    value INTEGER
  );
  CREATE INDEX vals1 ON vals(topic, value);

  INSERT INTO vals VALUES(1, 1, 1);
  INSERT INTO vals VALUES(2, 1, 1);
  INSERT INTO vals VALUES(3, 1, 1);
  INSERT INTO vals VALUES(4, 1, 1);
  INSERT INTO vals VALUES(5, 1, 1);
  INSERT INTO vals VALUES(6, 1, 1);
  INSERT INTO vals VALUES(7, 1, 1);
  INSERT INTO vals VALUES(8, 1, 1);
}

sqlite3 db2 test.db

do_execsql_test -db db2 1.1 {
  BEGIN;
    SELECT * FROM vals ORDER BY topic, value;
} {
  1 1 1 2 1 1 3 1 1 4 1 1 5 1 1 6 1 1 7 1 1 8 1 1
}

proc rand {min max} {
  expr {$min + int(abs(rand() * (1 + $max - $min)))}
}

do_test 1.2 {
  for {set j 0} {$j < 200} {incr j} {
    set rowid [rand 1 8]
    set val   [rand 1 1000]
    execsql { UPDATE vals SET value = $val WHERE ii = $rowid }

    if {1} {
      set dbx "db_$j"
      sqlite3 $dbx test.db
      set A($dbx) [$dbx eval {
        BEGIN;
          SELECT * FROM vals ORDER BY topic, value;
      }]
    }
  }

  set {} {}
} {}

#show_pagemap
#show_all_entries

puts [time {
do_execsql_test -db db2 1.3 {
  SELECT * FROM vals ORDER BY topic, value;
} {
  1 1 1 2 1 1 3 1 1 4 1 1 5 1 1 6 1 1 7 1 1 8 1 1
}
}]

foreach dbx [lsort [array names A]] {
  do_execsql_test -db $dbx 1.4.$dbx {
    SELECT * FROM vals ORDER BY topic, value
  } $A($dbx)

  $dbx close
}

db2 close

#-------------------------------------------------------------------------
hct_reset_db

do_execsql_test 2.0 {
  CREATE TABLE t1(a INTEGER PRIMARY KEY, b TEXT);
  INSERT INTO t1 VALUES(4, 'four');
}

sqlite3 db2 test.db

do_execsql_test -db db2 2.1 {
  BEGIN;
    SELECT * FROM t1
} {4 four}

do_execsql_test 2.2 {
  BEGIN;
    INSERT INTO t1 VALUES(2, 'two');
    DELETE FROM t1 WHERE a=4;
  COMMIT;

  BEGIN;
    INSERT INTO t1 VALUES(1, 'one');
    INSERT INTO t1 VALUES(3, 'three');
    DELETE FROM t1 WHERE a=2;
  COMMIT;
}

do_execsql_test -db db2 2.3 {
    SELECT * FROM t1
  END;
} {4 four}

finish_test
