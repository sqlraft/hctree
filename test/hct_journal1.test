# 2023 May 17
#
# The author disclaims copyright to this source code.  In place of
# a legal notice, here is a blessing:
#
#    May you do good and not evil.
#    May you find forgiveness for yourself and forgive others.
#    May you share freely, never taking more than you give.
#
#*************************************************************************
#

set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix hct_journal1

proc catch_hct_journal_init {db} {
  set rc [sqlite3_hct_journal_init db]
  if {$rc!="SQLITE_OK"} {
    return [list 1 [sqlite3_errmsg db]]
  }
  return "0 {}"
}

hct_reset_db
do_execsql_test 1.0 {
  CREATE TABLE t1(a);
}
do_test 1.1 {
  catch_hct_journal_init db
} {1 {not an empty database}}

db close
sqlite3 db test.db

do_test 1.2 {
  catch_hct_journal_init db
} {1 {not an empty database}}

hct_reset_db
do_execsql_test 1.3.1 {
  BEGIN;
}
do_test 1.3.2 {
  catch_hct_journal_init db
} {1 {open transaction on database}}
do_execsql_test 1.3.3 {
  COMMIT;
}

reset_db
do_test 1.4 {
  catch_hct_journal_init db
} {1 {not an hct database}}

hct_reset_db
do_test 1.5 {
  catch_hct_journal_init db
} {0 {}}

do_execsql_test 1.6 {
  SELECT cid, quote(schema_version), quote(hash) FROM sqlite_hct_baseline
} {
  0 X'00000000000000000000000000000000' X'00000000000000000000000000000000'
}

do_execsql_test 1.7 {
  PRAGMA table_info = sqlite_hct_journal
} {
  0 cid            INTEGER 0 {} 1 
  1 schema         TEXT 0 {} 0 
  2 data           BLOB 0 {} 0 
  3 schema_version BLOB 0 {} 0 
  4 hash           BLOB 0 {} 0 
  5 tid            INTEGER 0 {} 0 
  6 validcid       INTEGER 0 {} 0
}

do_catchsql_test 1.8 {
  INSERT INTO sqlite_hct_journal DEFAULT VALUES;
} {1 {attempt to write a readonly database}}
do_catchsql_test 1.9 {
  INSERT INTO sqlite_hct_baseline DEFAULT VALUES;
} {1 {attempt to write a readonly database}}

db close
sqlite3 db test.db

do_catchsql_test 1.10 {
  INSERT INTO sqlite_hct_journal DEFAULT VALUES;
} {1 {attempt to write a readonly database}}
do_catchsql_test 1.11 {
  INSERT INTO sqlite_hct_baseline DEFAULT VALUES;
} {1 {attempt to write a readonly database}}


finish_test


