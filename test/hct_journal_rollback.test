# 2023 August 5
#
# The author disclaims copyright to this source code.  In place of
# a legal notice, here is a blessing:
#
#    May you do good and not evil.
#    May you find forgiveness for yourself and forgive others.
#    May you share freely, never taking more than you give.
#
#*************************************************************************
#

set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix hct_journal_rollback

hct_reset_db
catch_hct_journal_init db
sqlite3_hct_journal_setmode db LEADER

do_execsql_test 1.0 {
  CREATE TABLE t1(a INTEGER PRIMARY KEY, b TEXT);      -- cid=7
  INSERT INTO t1 VALUES(1, 'one');                     -- cid=8
  INSERT INTO t1 VALUES(2, 'two');                     -- cid=9
  INSERT INTO t1 VALUES(3, 'three');                   -- cid=10
  INSERT INTO t1 VALUES(4, 'four');                    -- cid=11
  INSERT INTO t1 VALUES(5, 'five');                    -- cid=12
  INSERT INTO t1 VALUES(6, 'six');                     -- cid=13
  INSERT INTO t1 VALUES(7, 'seven');                   -- cid=14
  INSERT INTO t1 VALUES(8, 'eight');                   -- cid=15
  INSERT INTO t1 VALUES(9, 'nine');                    -- cid=16
  INSERT INTO t1 VALUES(10, 'ten');                    -- cid=17
  DELETE FROM t1 WHERE a=1;                            -- cid=18
}

do_execsql_test 1.1 {
  SELECT min(cid), max(cid) FROM sqlite_hct_journal
} {7 18}

forcedelete test.db2
sqlite3 db2 file:test.db2?hctree=1 -uri 1
catch_hct_journal_init db2

foreach cid {7 8 9 10 12 14 16 18} {
  db eval {SELECT * FROM sqlite_hct_journal WHERE cid=$cid} {
    set res [sqlite3_hct_journal_write db2 $cid $schema $data $schemacid]
  }
}

do_execsql_test -db db2 1.2 {
  SELECT * FROM t1
} {1 one 2 two 3 three}

do_test 1.3 {
  sqlite3_hct_journal_rollback db2 0
} {SQLITE_OK}

do_execsql_test -db db2 1.4 {
  SELECT * FROM t1
} {1 one 2 two 3 three}

db2 close
sqlite3 db2 test.db2

do_execsql_test -db db2 1.5 {
  SELECT * FROM t1
} {1 one 2 two 3 three}

do_execsql_test -db db2 1.6 {
  SELECT min(cid), max(cid) FROM sqlite_hct_journal
} {7 10}

finish_test

