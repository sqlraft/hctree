# 2025 July 31 
#
# The author disclaims copyright to this source code.  In place of
# a legal notice, here is a blessing:
#
#    May you do good and not evil.
#    May you find forgiveness for yourself and forgive others.
#    May you share freely, never taking more than you give.
#
#*************************************************************************
# This file implements regression tests for SQLite library.
#

set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix hct_io

do_faultsim_test 1 -faults hctio -prep {
  forcedelete test.db
} -body {
  sqlite3 db file:test.db?hctree=1 -uri 1
  execsql {
    CREATE TABLE t1(x, y);
  }
} -test {
  faultsim_test_result {0 {}} 
}

db close
forcedelete test.db

set script "BEGIN;\n"
for {set ii 0} {$ii < 1000} {incr ii} {
  append script "CREATE TABLE t$ii (x, y);\n"
}
append script "COMMIT;\n"

do_faultsim_test 2 -faults hctio -prep {
  forcedelete test.db
} -body {
  sqlite3 db file:test.db?hctree=1 -uri 1
  execsql $::script
} -test {
  faultsim_test_result {0 {}} 
}

hct_reset_db
do_execsql_test 3.0 {
  CREATE TABLE x1(a, b);
  INSERT INTO x1 VALUES(1, zeroblob(1_000_000));
}

db close
db_save_and_close

do_faultsim_test 2 -faults hctio -prep {
  catch { db close }
  db_restore_and_reopen
} -body {
  sqlite3 db test.db
  execsql $::script
} -test {
  faultsim_test_result {0 {}} 
}

finish_test



