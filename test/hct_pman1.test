# 2021 January 01
#
# The author disclaims copyright to this source code.  In place of
# a legal notice, here is a blessing:
#
#    May you do good and not evil.
#    May you find forgiveness for yourself and forgive others.
#    May you share freely, never taking more than you give.
#
#*************************************************************************
# This file implements regression tests for SQLite library.
#

set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix hct_pman1

do_execsql_test 1.0 {
  CREATE TABLE t1(a INTEGER PRIMARY KEY, b BLOB);
  CREATE INDEX i1 ON t1(b);
}

proc dumpdb {} {
  if 0 {
  execsql_pp { 
    SELECT * FROM hctpgmap, hctdb 
      WHERE logical_in_use AND hctpgmap.pgno=hctdb.pgno
  }
  }

  if 0 {
    execsql_pp { 
      SELECT * FROM hctpgmap, hctentry 
        WHERE logical_in_use AND hctpgmap.pgno=hctentry.pgno
    }
  }

  execsql_pp {
    WITH map AS (
      SELECT * FROM hctpgmap, hctdb 
      WHERE logical_in_use AND hctpgmap.pgno=hctdb.pgno
    ),

    chain(type, s, l, c) AS (
      SELECT pgtype, logical, logical, logical FROM map WHERE logical NOT IN (
        SELECT peer FROM map
      ) 
      UNION ALL
      SELECT type, s, peer, c || '->' || peer FROM chain, map WHERE l=logical
    )

    SELECT type, c FROM chain WHERE l NOT IN (
      SELECT logical FROM map
    )
  }

  execsql_pp {
    SELECT count(*) FROM hctpgmap WHERE physical_in_use;
    SELECT count(*) FROM hctpgmap WHERE logical_in_use;
  }

  execsql_pp {
    WITH fname(i, s) AS ( VALUES
        (3, 'logical_eof'), (4, 'physical_eof'), 
        (5, 'transid'), (6, 'commitid')
    )
    SELECT s, pgno FROM hctpgmap, fname WHERE logical=i;
  }
}

proc do_pageleak_test {tn} {
  set nPhys [db one {SELECT count(*) FROM hctpgmap WHERE physical_in_use}]
  set nLog  [db one {SELECT count(*) FROM hctpgmap WHERE logical_in_use}]

  uplevel list [do_test $tn [list expr $nPhys] $nLog]
  if {$nLog!=$nPhys} {
    execsql_pp {
      SELECT logical AS "leaked_physical_page" FROM hctpgmap WHERE 
        physical_in_use AND 
        logical NOT IN (
          SELECT pgno FROM hctpgmap WHERE logical_in_use
        )
    }
  }
}

set nStep 10000
for {set ii 1} {$ii <= $nStep} {incr ii} {
  do_execsql_test 1.$ii {
    REPLACE INTO t1 VALUES($ii%500, randomblob(100));
  }
  do_pageleak_test 1.$ii.pageleak
} 

integrity_check 1.$ii.ic
# dumpdb

finish_test



