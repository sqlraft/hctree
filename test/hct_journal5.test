# 2023 June 30
#
# The author disclaims copyright to this source code.  In place of
# a legal notice, here is a blessing:
#
#    May you do good and not evil.
#    May you find forgiveness for yourself and forgive others.
#    May you share freely, never taking more than you give.
#
#*************************************************************************
#

set testdir [file dirname $argv0]
source $testdir/tester.tcl
source $testdir/hct_common.tcl
set testprefix hct_journal5

hct_reset_db
catch_hct_journal_init db
sqlite3_hct_journal_setmode db LEADER


do_execsql_test 1.0 {
  CREATE TABLE t1(a INTEGER PRIMARY KEY, b TEXT);
  INSERT INTO t1 VALUES(1, 'one');
}

do_perm_test 1.1 {
  INSERT INTO t1 VALUES(2, 'two');
  INSERT INTO t1 VALUES(3, 'three');
  INSERT INTO t1 VALUES(4, 'four');
}

do_execsql_test 1.2 {
  SELECT * FROM t1
} {
  1 one  2 two  3 three  4 four
}

do_perm_test 1.3 {
  UPDATE t1 SET b='five' WHERE a=4;
  UPDATE t1 SET b='six' WHERE a=4;
  UPDATE t1 SET b='seven' WHERE a=4;
  UPDATE t1 SET b='eight' WHERE a=4;
} 

do_perm_test 1.4 {
  DELETE FROM t1 WHERE a=3;
  INSERT INTO t1 VALUES(3, 'xyz');
  UPDATE t1 SET b='hello' WHERE a=3;
}

do_perm_test 1.5 {
  INSERT INTO t1 VALUES(9, 'nine');
  DELETE FROM t1 WHERE a=9;
}

do_perm_test 1.6 {
  UPDATE t1 SET b='abc' WHERE a=2;
  DELETE FROM t1 WHERE a=2;
}

do_perm_test 1.7 {
  INSERT INTO t1 VALUES(2, 'eleven');
  DELETE FROM t1 WHERE a=2;
  INSERT INTO t1 VALUES(2, 'twelve');
  DELETE FROM t1 WHERE a=2;
  INSERT INTO t1 VALUES(2, 'thirteen');
  DELETE FROM t1 WHERE a=2;
}

do_perm_test 1.8 {
  BEGIN;
    INSERT INTO t1 VALUES(39, 'thirtynine');
    DELETE FROM t1 WHERE a=39;
  COMMIT;
  BEGIN;
    INSERT INTO t1 VALUES(39, 'forty');
    DELETE FROM t1 WHERE a=39;
  COMMIT;
  BEGIN;
    INSERT INTO t1 VALUES(39, 'fifty');
    DELETE FROM t1 WHERE a=39;
  COMMIT;
}

do_perm_test 1.9 {
  INSERT INTO t1 VALUES(100, 'hundred');
  CREATE TABLE t2(x INTEGER PRIMARY KEY, y TEXT);
  INSERT INTO t2 VALUES(100, 'hundred');
}

finish_test

