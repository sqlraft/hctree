# 2025 April 18
#
# The author disclaims copyright to this source code.  In place of
# a legal notice, here is a blessing:
#
#    May you do good and not evil.
#    May you find forgiveness for yourself and forgive others.
#    May you share freely, never taking more than you give.
#
#*************************************************************************
# This file implements regression tests for SQLite library.
#

set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix hct_index2

# Setup for logging 
#db close
##sqlite3_shutdown
#sqlite_log_to_stdout

hct_reset_db

set NROW 30000

proc rand {min max} {
  expr {$min + int(abs(rand() * (1 + $max - $min)))}
}
db func rand rand

proc randtext {n} {
  set char [list a B c D e F g H i J k L m N o P q R s T u V w X y Z]
  set ret ""
  for {set ii 0} {$ii<$n} {incr ii} {
    append ret [lindex $char [rand 0 [llength $char]]]
  }
  set ret
}
db func randtext randtext

do_execsql_test 1.0 {
  CREATE TABLE t1(ii INTEGER PRIMARY KEY, a INTEGER, b TEXT, c BLOB);
  CREATE INDEX i1 ON t1(a DESC, b);
}

do_execsql_test 1.1 {
  WITH s(ii) AS (
    SELECT 1 UNION ALL SELECT ii+1 FROM s WHERE ii<($NROW/2)
  )
  INSERT INTO t1(a, b, c) SELECT 100, randtext(25), randtext(25) FROM s;
}

do_execsql_test 1.2 {
  WITH s(ii) AS (
    SELECT 1 UNION ALL SELECT ii+1 FROM s WHERE ii<($NROW/2)
  )
  INSERT INTO t1(a, b, c) SELECT 100, randtext(25), randtext(25) FROM s;
}

do_test 1.3 {
  for {set ii 60000} {$ii>($NROW*3/4)} {incr ii -1} {
    execsql {
      DELETE FROM t1 WHERE ii=$ii
    }
  }
} {}

do_execsql_test 1.4 {
  PRAGMA integrity_check
} {ok}

#-------------------------------------------------------------------------
hct_reset_db
db func randtext randtext
db func rand rand

do_execsql_test 2.0 {
  CREATE TABLE t1(ii INTEGER PRIMARY KEY, a INTEGER, b TEXT, c BLOB);
  CREATE INDEX i1 ON t1(a DESC, b);
}

do_execsql_test 2.1 {
  WITH s(ii) AS (
    SELECT 1 UNION ALL SELECT ii+1 FROM s WHERE ii<5000
  )
  INSERT INTO t1(a, b, c) SELECT 100, randtext(25), randtext(25) FROM s;
}

do_test 2.2 {
  for {set ii 0} {$ii < 500} {incr ii} {
    execsql {
      INSERT INTO t1(a, b, c) VALUES(100, 'AAAAhelloworld', randtext(25));
      DELETE FROM t1 WHERE rowid = last_insert_rowid();
    }
  }
} {}

do_execsql_test 2.3 {
  PRAGMA hct_quiescent_integrity_check = 1;
  PRAGMA integrity_check;
} {1 ok}

#-------------------------------------------------------------------------
hct_reset_db
db func randtext randtext

do_execsql_test 3.0 {
  CREATE TABLE t1(a INTEGER PRIMARY KEY, b TEXT);
  CREATE INDEX i1 ON t1(b);

  BEGIN;
    INSERT INTO t1 VALUES(1, 'AAAAAAAAAAAAAAAAAAAAAA');
    INSERT INTO t1 VALUES(1000, 'zzzzzzzzzzzzzzzzzzzzzz');
  COMMIT;
  BEGIN;
    SELECT * FROM t1;
} {1 AAAAAAAAAAAAAAAAAAAAAA 1000 zzzzzzzzzzzzzzzzzzzzzz}

sqlite3 db2 test.db

do_execsql_test -db db2 3.1 {
  DELETE FROM t1 WHERE a=1000;
  WITH s(i) AS (
    SELECT 2 UNION ALL SELECT i+1 FROM s WHERE (i+1)<100
  )
  INSERT INTO t1 SELECT i, 'oooooooooooooooooooo' FROM s;
}

do_execsql_test 3.2 {
    SELECT * FROM t1;
    SELECT * FROM t1 ORDER BY b;
} {
  1 AAAAAAAAAAAAAAAAAAAAAA 1000 zzzzzzzzzzzzzzzzzzzzzz
  1 AAAAAAAAAAAAAAAAAAAAAA 1000 zzzzzzzzzzzzzzzzzzzzzz
}

do_execsql_test -db db2 3.3 {
  DELETE FROM t1 WHERE a<100
} {}

do_execsql_test 3.4 {
    SELECT * FROM t1;
    SELECT * FROM t1 ORDER BY b;
} {
  1 AAAAAAAAAAAAAAAAAAAAAA 1000 zzzzzzzzzzzzzzzzzzzzzz
  1 AAAAAAAAAAAAAAAAAAAAAA 1000 zzzzzzzzzzzzzzzzzzzzzz
}

do_execsql_test -db db2 3.5 {
  DELETE FROM t1;
} {}

do_execsql_test 3.6 {
    SELECT * FROM t1;
    SELECT * FROM t1 ORDER BY b;
} {
  1 AAAAAAAAAAAAAAAAAAAAAA 1000 zzzzzzzzzzzzzzzzzzzzzz
  1 AAAAAAAAAAAAAAAAAAAAAA 1000 zzzzzzzzzzzzzzzzzzzzzz
}

do_execsql_test -db db2 3.7 {
  SELECT * FROM t1;
  SELECT * FROM t1 ORDER BY b;
} {}


finish_test

