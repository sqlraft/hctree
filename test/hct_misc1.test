# 2020 October 8
#
# The author disclaims copyright to this source code.  In place of
# a legal notice, here is a blessing:
#
#    May you do good and not evil.
#    May you find forgiveness for yourself and forgive others.
#    May you share freely, never taking more than you give.
#
#*************************************************************************
# This file implements regression tests for SQLite library.
#

set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix hct_misc1

if 1 {

do_execsql_test 1.1 { 
  CREATE TABLE t1(a, b);
  INSERT INTO t1 VALUES(1, 1);
  INSERT INTO t1 VALUES(2, 2);
}

#execsql_pp { SELECT rowid, sql FROM sqlite_schema }
#execsql_pp { SELECT * FROM hctdb }

do_execsql_test 1.2 {
  SELECT * FROM t1;
} {1 1 2 2}

do_execsql_test 1.2 {
  CREATE TABLE t2(x);
}
#execsql_pp { SELECT rowid, sql FROM sqlite_schema }

do_execsql_test 1.3 {
  INSERT INTO t2 VALUES('a');
  INSERT INTO t2 VALUES('b');
}

do_execsql_test 1.4 {
  SELECT name, rootpage FROM sqlite_master
} {t1 33 t2 34}

#do_test 1.2 {
  #set res [list]
  #db eval { SELECT * FROM t1 CROSS JOIN t2 } {
    #if {$a!=""} { 
      #db eval { DELETE FROM t1 WHERE a=$a }
    #}
    #lappend res $a $b $x
  #}
  #set res
#} {1 1 a {} {} b 2 2 a {} {} b}

reset_db
do_execsql_test 2.0 {
  CREATE TABLE t1(a INTEGER PRIMARY KEY, b, c);
  -- CREATE INDEX x1 ON t1(b, c);
  INSERT INTO t1(a,b,c) VALUES(1, 1, zeroblob(80));
  INSERT INTO t1(a,b,c) SELECT a+1, 1, c FROM t1;
  INSERT INTO t1(a,b,c) SELECT a+2, 1, c FROM t1;
  INSERT INTO t1(a,b,c) SELECT a+10, 2, c FROM t1 WHERE b=1;
  INSERT INTO t1(a,b,c) SELECT a+20, 3, c FROM t1 WHERE b=1;
}

reset_db
do_execsql_test 3.0 {
  CREATE TABLE test1(f1 int, f2 int);
  INSERT INTO test1(f1,f2) VALUES(11,22);
}

do_execsql_test 3.1 {
  DELETE FROM test1;
}

reset_db
do_execsql_test 4.0 {
  CREATE TABLE t1(k INTEGER PRIMARY KEY, v BLOB);
}
do_execsql_test 4.1 {
  BEGIN;
    SAVEPOINT xyz2 ;
      INSERT INTO t1 VALUES(97, '0.390235061007661') ;
    ROLLBACK TO xyz2 ;
}

do_execsql_test 4.2 {
  SELECT * FROM t1 ORDER BY k
} {}

#-------------------------------------------------------------------------
reset_db
do_execsql_test 5.0 {
  CREATE TABLE v1(k INTEGER PRIMARY KEY, v BLOB);
}

do_execsql_test 5.1 {
  BEGIN;
    INSERT  INTO v1 VALUES(57, '0.211249098745756') ;
    SAVEPOINT xyz6;
      INSERT INTO v1 VALUES(32, '0.430095704007007') ;
    ROLLBACK TO xyz6 ;
}

do_execsql_test 5.2 {
  SELECT * FROM v1;
} {
  57 0.211249098745756
}

#-------------------------------------------------------------------------
reset_db
do_execsql_test 6.0 {
  BEGIN;
    SAVEPOINT abc;
      CREATE TABLE t1(a, b);
      CREATE TABLE t2(a, b);
    ROLLBACK TO abc;
  COMMIT;
}

}

#-------------------------------------------------------------------------
reset_db
do_execsql_test 7.0 {
  CREATE TABLE t1(a, b);
}
do_execsql_test 7.1 {
  INSERT INTO t1(rowid, a, b) VALUES(1, 'abc', 'def');
}
do_execsql_test 7.2 {
  INSERT INTO t1 VALUES('ghi', 'jkl');
}
do_execsql_test 7.3 {
  SELECT rowid, * FROM t1
} {1 abc def  2 ghi jkl}
do_execsql_test 7.4 {
  BEGIN;
    INSERT INTO t1 VALUES('mno', 'pqr');
    INSERT INTO t1 VALUES('stu', 'vwx');
  COMMIT;
}
do_execsql_test 7.5 {
  SELECT rowid, * FROM t1
} {1 abc def  2 ghi jkl 3 mno pqr 4 stu vwx}

#-------------------------------------------------------------------------
reset_db
do_execsql_test 8.0 {
  CREATE TABLE t1(a, b);
}
do_execsql_test 8.1.0 {
  INSERT INTO t1(rowid, a, b) VALUES(4, 'stu', 'vwx');
}
do_execsql_test 8.1.1 {
  INSERT INTO t1(rowid, a, b) VALUES(2, 'ghi', 'jkl');
} 
do_execsql_test 8.2 {
  BEGIN;
    INSERT INTO t1(rowid, a, b) VALUES(1, 'abc', 'def');
    INSERT INTO t1(rowid, a, b) VALUES(3, 'mno', 'pqr');
}
do_execsql_test 8.3 {
  SELECT rowid, * FROM t1 ORDER BY 1
} {1 abc def  2 ghi jkl 3 mno pqr 4 stu vwx}
do_execsql_test 8.4 {
  COMMIT
}
do_execsql_test 8.5 {
  SELECT rowid, * FROM t1 ORDER BY 1
} {1 abc def  2 ghi jkl 3 mno pqr 4 stu vwx}

#-------------------------------------------------------------------------
#
reset_db
do_execsql_test 9.0 {
  CREATE TABLE t1(x INTEGER PRIMARY KEY, b TEXT);
}
do_test 9.1.0 {
  for {set i 1} {$i<100} {incr i} {
    set t [string repeat [format %.3d $i] 200]
    execsql { INSERT INTO t1 VALUES($i, $t) }
  }
} {}

#execsql_pp { SELECT * FROM hctdb } 
#execsql_pp { SELECT x, length(b) FROM t1 WHERE x=2 }
do_execsql_test 9.1.1 {
  SELECT x, length(b) FROM t1 WHERE x=2;
} {2 600}
do_execsql_test 9.1.2 {
  SELECT x, length(b) FROM t1 WHERE x=6;
} {6 600}
do_execsql_test 9.2 {
  SELECT x, length(b) FROM t1 WHERE x<10
} {1 600 2 600 3 600 4 600 5 600 6 600 7 600 8 600 9 600}

do_execsql_test 9.3 {
  SELECT x, length(b) FROM t1 WHERE +x=50
} {50 600}
do_execsql_test 9.4 {
  SELECT x, length(b) FROM t1 WHERE x=2
} {2 600}
do_execsql_test 9.5 {
  SELECT x, length(b) FROM t1 WHERE x=50
} {50 600}
do_execsql_test 9.6 {
  SELECT x, length(b) FROM t1 WHERE x BETWEEN 50 AND 55
} {50 600 51 600 52 600 53 600 54 600 55 600}

#-------------------------------------------------------------------------
#
reset_db
do_execsql_test 10.0 {
  CREATE TABLE t1(x INTEGER PRIMARY KEY, b TEXT);
}
do_execsql_test 10.1 {
  BEGIN;
    INSERT INTO t1 VALUES(1, 'one');
    INSERT INTO t1 VALUES(3, 'three');
    INSERT INTO t1 VALUES(5, 'five');
} {}
do_execsql_test 10.2 {
  SELECT * FROM t1
} {1 one 3 three 5 five}
do_execsql_test 10.3 {
  COMMIT;
  SELECT * FROM t1
} {1 one 3 three 5 five}
do_execsql_test 10.4 {
  BEGIN;
    INSERT INTO t1 VALUES(2, 'two');
    INSERT INTO t1 VALUES(4, 'four');
    INSERT INTO t1 VALUES(6, 'six');
} {}
do_execsql_test 10.5 {
  SELECT * FROM t1
} {1 one 2 two 3 three 4 four 5 five 6 six}
do_execsql_test 10.6 {
  COMMIT;
  SELECT * FROM t1;
} {1 one 2 two 3 three 4 four 5 five 6 six}

sqlite3 db2 test.db
do_test 10.7 {
  db2 eval { SELECT * FROM t1 }
} {1 one 2 two 3 three 4 four 5 five 6 six}
db2 close

#-------------------------------------------------------------------------
#
reset_db
do_execsql_test 11.0 {
  CREATE TABLE t1(x INTEGER PRIMARY KEY, b TEXT);
}
sqlite3 db2 test.db
do_execsql_test -db db2 11.1 {
  SELECT * FROM t1
} {}
do_execsql_test 11.2 {
  BEGIN;
    INSERT INTO t1 VALUES(1, 'one');
    INSERT INTO t1 VALUES(10, 'ten');
  COMMIT;
} {}
do_execsql_test -db db2 11.3 {
  SELECT * FROM t1
} {1 one 10 ten}
do_execsql_test -db db2 11.4 {
  BEGIN;
    SELECT * FROM t1;
} {1 one 10 ten}
do_execsql_test 11.5 {
  INSERT INTO t1 VALUES(100, 'hundred');
  INSERT INTO t1 VALUES(1000, 'thousand');
} {}
do_execsql_test -db db2 11.6 {
  SELECT * FROM t1
} {1 one 10 ten}
do_execsql_test -db db2 11.7 {
  COMMIT;
  SELECT * FROM t1
} {1 one 10 ten 100 hundred 1000 thousand}

db2 close

#-------------------------------------------------------------------------
reset_db
sqlite3 db2 test.db

foreach {tn db sql res} {
  0 db   "CREATE TABLE t1(x INTEGER PRIMARY KEY, b TEXT)" {}
  1 db   "INSERT INTO t1 VALUES(2, 'two'), (3, 'three')"  {}
  2 db2                 "BEGIN" {}
  3 db2                 "  SELECT * FROM t1" 
                           {2 two 3 three}
  4 db   "INSERT INTO t1 VALUES(1, 'one'), (4, 'four')"   {}
  5 db2                 "  SELECT * FROM t1 WHERE x>0"
                           {2 two 3 three}

  6 db2                 "  SELECT * FROM t1 WHERE x>=1"
                           {2 two 3 three}
  7 db2                 "COMMIT" {}
  8 db2                 "SELECT * FROM t1"
                         {1 one 2 two 3 three 4 four}
} {
  do_execsql_test -db $db 12.$tn $sql $res
}

db2 close

#-------------------------------------------------------------------------
reset_db
sqlite3 db2 test.db
do_execsql_test 13.0 {
  CREATE TABLE t1(x INTEGER PRIMARY KEY, b TEXT);
  WITH s(i) AS (
    SELECT 1 UNION ALL SELECT i+1 FROM s WHERE i<100
  )
  INSERT INTO t1(b) SELECT randomblob(100) FROM s;
}

do_execsql_test 13.1 {
  SELECT max(+x) FROM t1
} {100}

do_execsql_test 13.1 {
  INSERT INTO t1(b) VALUES('abc');
} {}

#-------------------------------------------------------------------------
reset_db
sqlite3 db2 test.db
do_execsql_test 14.0 {
  CREATE TABLE t1(x INTEGER PRIMARY KEY, b TEXT);
  INSERT INTO t1 VALUES(1, 'one');
  INSERT INTO t1 VALUES(2, 'two');
  INSERT INTO t1 VALUES(3, 'three');
  SELECT * FROM t1
} {1 one 2 two 3 three}

do_execsql_test 14.1 {
  DELETE FROM t1 WHERE x=2;
}

do_execsql_test 14.2 {
  SELECT * FROM t1
} {1 one 3 three}

finish_test

