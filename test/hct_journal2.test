# 2023 May 17
#
# The author disclaims copyright to this source code.  In place of
# a legal notice, here is a blessing:
#
#    May you do good and not evil.
#    May you find forgiveness for yourself and forgive others.
#    May you share freely, never taking more than you give.
#
#*************************************************************************
#

set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix hct_journal2

proc catch_hct_journal_init {db} {
  set rc [sqlite3_hct_journal_init db]
  if {$rc!="SQLITE_OK"} {
    return [list 1 [sqlite3_errmsg db]]
  }
  return "0 {}"
}

hct_reset_db
catch_hct_journal_init db

do_test 1.0.1 {
  sqlite3_hct_journal_mode db
} {NORMAL}
do_test 1.0.2 {
  sqlite3_hct_journal_setmode db LEADER
} {SQLITE_OK}
do_test 1.0.3 {
  sqlite3_hct_journal_mode db
} {LEADER}
do_test 1.0.4 {
  sqlite3_hct_journal_setmode db FOLLOWER
} {SQLITE_OK}
do_test 1.0.5 {
  sqlite3_hct_journal_mode db
} {FOLLOWER}
do_test 1.0.6 {
  sqlite3_hct_journal_setmode db LEADER
} {SQLITE_OK}
do_test 1.0.7 {
  sqlite3_hct_journal_setmode db FOLLOWER
} {SQLITE_OK}

proc write_follower { db sql cid snapshot } {
  $db eval { BEGIN CONCURRENT }
  $db eval $sql
  sqlite3_hct_journal_follower_commit $db $sql $cid $snapshot
}

proc do_followersql_test {tn cid snapshot sql} {
  do_test $tn "
    lindex \[ write_follower db {$sql} $cid $snapshot \] 0
  " SQLITE_OK
}

do_followersql_test 1.0 2 1 {
  CREATE TABLE t1(x INTEGER PRIMARY KEY, y);
}

do_followersql_test 1.1 3 1 {
  INSERT INTO t1 VALUES(1, 2);
}

do_followersql_test 1.2 5 1 {
  INSERT INTO t1 VALUES(5, 6);
}

do_execsql_test 1.3 {
  SELECT * FROM t1
} {1 2}

do_test 1.4.1 {
  sqlite3_hct_journal_setmode db LEADER
} {SQLITE_ERROR}

do_test 1.4.2 {
  sqlite3_errmsg db
} {non-contiguous journal table}

do_execsql_test 1.4.3 {
  SELECT cid FROM hct_journal
} {1 2 3 5}

do_followersql_test 1.5 4 1 {
  INSERT INTO t1 VALUES(3, 4);
}

do_execsql_test 1.6 {
  SELECT * FROM t1
} {1 2 3 4 5 6}

do_test 1.7 {
  sqlite3_hct_journal_setmode db LEADER
} {SQLITE_OK}

do_execsql_test 1.8 {
  SELECT * FROM t1
} {1 2 3 4 5 6}

do_test 1.9 {
  sqlite3_hct_journal_setmode db FOLLOWER
} {SQLITE_OK}

do_followersql_test 1.10 7 1 {
  INSERT INTO t1 VALUES(7, 8);
}

do_test 1.11.1 {
  sqlite3_hct_journal_setmode db NORMAL
} {SQLITE_ERROR}

do_test 1.11.2 {
  sqlite3_errmsg db
} {non-contiguous journal table}

finish_test


