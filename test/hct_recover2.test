# 2022 July 1
#
# The author disclaims copyright to this source code.  In place of
# a legal notice, here is a blessing:
#
#    May you do good and not evil.
#    May you find forgiveness for yourself and forgive others.
#    May you share freely, never taking more than you give.
#
#*************************************************************************
# This file implements regression tests for SQLite library.
#

set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix hct_recover2

proc write_script {txt} {
  set fd [open script.tcl w]
  puts -nonewline $fd $txt
  close $fd
}

hct_reset_db

do_execsql_test 1.0 {
  CREATE TABLE t1(x, y, p);
  CREATE INDEX i1 ON t1(p, x);
  CREATE INDEX i2 ON t1(p, y);
  CREATE INDEX i3 ON t1(p, y);
  CREATE INDEX i4 ON t1(p, y);

  WITH s(i) AS (
    VALUES(1) UNION ALL SELECT i+1 FROM s WHERE i<100
  )
  INSERT INTO t1 SELECT i, i, hex(randomblob(250)) FROM s;
}

do_execsql_test 1.1 {
  PRAGMA integrity_check
} {ok}

proc do_recover_test {tn sql} {
  for {set ii 1} {$ii<500} {incr ii} {
    write_script [subst {
      sqlite3_hct_proc_failure $ii
      sqlite3 db test.db
      db eval {$sql}
    }]

    db_restore

    set rc [catch { exec [info nameofexec] script.tcl } msg]

    #set rc [catch { 
    #  set fd [open "|[info nameofexec] script.tcl"]
    #  while {![eof $fd]} { gets $fd }
    #  close $fd
    #} msg]

    # catch { close $fd }

    sqlite3 db test.db
    do_execsql_test "$tn.$ii..($rc $msg)" {
      PRAGMA integrity_check;
    } {ok}
    db close
    if {$rc==0} break
  }
}

db_save_and_close

do_recover_test 1 {
  BEGIN;
    INSERT INTO t1 VALUES(101, 101, hex(randomblob(250)));
  COMMIT;
}

do_recover_test 2 {
  BEGIN;
    DELETE FROM t1 WHERE x=50;
  COMMIT;
}

do_recover_test 3 {
  BEGIN;
    UPDATE t1 SET p=hex(randomblob(250)) WHERE x=22;
  COMMIT;
}

do_recover_test 4 {
  BEGIN;
    INSERT INTO t1 VALUES(101, 101, hex(randomblob(250)));
    INSERT INTO t1 VALUES(102, 102, hex(randomblob(250)));
  COMMIT;
}


do_recover_test 5 {
  BEGIN;
    INSERT INTO t1 VALUES(101, 101, hex(randomblob(250)));
    DELETE FROM t1 WHERE x=33;
  COMMIT;
}

do_recover_test 6 {
  BEGIN;
    DELETE FROM t1 WHERE x<50;
  COMMIT;
}

do_recover_test 7 {
  BEGIN;
    DELETE FROM t1 WHERE 1;
  COMMIT;
}

do_recover_test 8 {
  BEGIN;
    UPDATE t1 SET p = hex(randomblob(250));
  COMMIT;
}


do_recover_test 9 {
  BEGIN;
    DELETE FROM t1;
  COMMIT;
}

finish_test


