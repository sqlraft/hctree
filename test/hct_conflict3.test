# 2025 June 24
#
# The author disclaims copyright to this source code.  In place of
# a legal notice, here is a blessing:
#
#    May you do good and not evil.
#    May you find forgiveness for yourself and forgive others.
#    May you share freely, never taking more than you give.
#
#*************************************************************************
# This file implements regression tests for SQLite library.
#

set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix hct_conflict3

db close
#sqlite3_shutdown
#sqlite_log_to_stdout

hct_reset_db
do_execsql_test 1.0 {
  BEGIN;
    CREATE TABLE t1(a INTEGER PRIMARY KEY, b);
    INSERT INTO t1 VALUES(1, 'one');
    INSERT INTO t1 VALUES(2, 'two');
    INSERT INTO t1 VALUES(3, 'three');
    INSERT INTO t1 VALUES(4, 'four');
    INSERT INTO t1 VALUES(5, 'five');
    INSERT INTO t1 VALUES(6, 'six');

    CREATE TABLE t2(x INTEGER PRIMARY KEY, y);
  COMMIT;
  DELETE FROM t1 WHERE a=1;
}

sqlite3 db2 test.db
do_execsql_test 1.1 {
  BEGIN CONCURRENT;
    SELECT * FROM t1 WHERE a<3 ORDER BY a ASC;
    INSERT INTO t2 VALUES(10, 'ten');
} {2 two}

do_execsql_test -db db2 1.2 {
  DELETE FROM t1 WHERE a=2;
}
db2 close

do_catchsql_test 1.3 {
  COMMIT;
} {1 {database is locked}}
execsql ROLLBACK

#-------------------------------------------------------------------------

db close
#sqlite3_shutdown
#sqlite_log_to_stdout
#autoinstall_test_functions
hct_reset_db

proc randint {min max} {
  set val [expr int( rand() * (1+$max-$min) ) + $min]
  return $val
}
db func randint randint

do_execsql_test 2.0 {
  CREATE TABLE x1(a INTEGER PRIMARY KEY, b TEXT, c TEXT, d TEXT);
  WITH s(i) AS (
    SELECT 1 UNION ALL SELECT i+1 FROM s WHERE i<100
  )
  INSERT INTO x1(b, c, d) 
  SELECT randint(1, 5), randstr(10, 10), randstr(10, 10) FROM s;

  CREATE INDEX x1bcd ON x1(b, c, d);

  CREATE TABLE x2(x);
  CREATE TABLE x3(y);
}

do_test 2.1 {
  execsql {
    BEGIN CONCURRENT;
      SELECT * FROM x1 WHERE b=3 ORDER BY c DESC;
      INSERT INTO x2 VALUES(1);
      INSERT INTO x2 VALUES(2);
  }
  set {} {}
} {}

sqlite3 db2 test.db
do_execsql_test -db db2 2.2 {
  INSERT INTO x3 VALUES(1);
}
db2 close


do_execsql_test 2.3 {
  COMMIT
} {}


#show_pagemap
#show_all_entries

#-------------------------------------------------------------------------

db close
sqlite3_shutdown
sqlite_log_to_stdout
autoinstall_test_functions
hct_reset_db

do_execsql_test 3.0 {
  CREATE TABLE t1(a INTEGER PRIMARY KEY, b INTEGER, c INTEGER);
  CREATE TABLE t2(x INTEGER PRIMARY KEY);

  CREATE INDEX i1 ON t1(b, c);
  INSERT INTO t1(a, b, c) 
      VALUES(1, 10, 1), (2, 10, 2), (3, 10, 3), (4, 10, 4),
            (5, 20, 1), (6, 20, 2), (7, 20, 3), (8, 20, 4),
            (9, 30, 1), (10, 30, 2), (11, 30, 3), (12, 30, 4);
}

do_execsql_test 3.1 {
  BEGIN CONCURRENT;
    SELECT * FROM t1 WHERE b=20 ORDER BY c DESC;
    INSERT INTO t2 VALUES(1);
} {
  8 20 4
  7 20 3
  6 20 2
  5 20 1
}

do_test 3.2 {
  sqlite3 db2 test.db
  db2 eval {
    UPDATE t1 SET c=500 WHERE a=7
  }
} {}

do_catchsql_test 3.3 {
  COMMIT
} {1 {database is locked}}

finish_test

