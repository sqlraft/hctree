# 2022 November 16
#
# The author disclaims copyright to this source code.  In place of
# a legal notice, here is a blessing:
#
#    May you do good and not evil.
#    May you find forgiveness for yourself and forgive others.
#    May you share freely, never taking more than you give.
#
#*************************************************************************
# This file implements regression tests for SQLite library.
#

set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix hct_thread1

hct_reset_db

set NSECOND 5
set NTHREAD 5


do_execsql_test 1.0 { 
  CREATE TABLE t1(i INTEGER PRIMARY KEY, a, b);
  WITH s(i) AS (
    SELECT 1 UNION ALL SELECT i+1 FROM s WHERE i<10000
  )
  INSERT INTO t1 SELECT i, randomblob(32), randomblob(32) FROM s;
  CREATE INDEX i1 ON t1(a);
  CREATE INDEX i2 ON t1(b);
}

sqlite_thread_test T test.db
for {set tt 1} {$tt < $NTHREAD} {incr tt} {
  T thread $tt {
    BEGIN CONCURRENT;
    UPDATE t1 SET a = randomblob(32), b = randomblob(32) 
      WHERE i=abs(random() % 10000)+1;
    SELECT * FROM t1 WHERE i>abs(random() % 10000) LIMIT 1000;
    COMMIT;
  }
}

puts "running for $NSECOND seconds with $NTHREAD threads..."
do_test 1.1 {
  T configure -nsecond $NSECOND
  T run
} {}
puts [T result]
T destroy

do_execsql_test 1.2 { PRAGMA integrity_check } {ok}

finish_test

